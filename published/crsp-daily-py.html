<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ian D. Gow">
<meta name="dcterms.date" content="2025-01-23">
<meta name="keywords" content="Python">

<title>Using DuckDB with WRDS: Python version – notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-5b4ad623e5705c0698d39aec6f10cf02.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#getting-data" id="toc-getting-data" class="nav-link" data-scroll-target="#getting-data"><span class="header-section-number">2</span> Getting data</a>
  <ul class="collapse">
  <li><a href="#general-set-up" id="toc-general-set-up" class="nav-link" data-scroll-target="#general-set-up"><span class="header-section-number">2.1</span> General set-up</a></li>
  <li><a href="#fama-french-data" id="toc-fama-french-data" class="nav-link" data-scroll-target="#fama-french-data"><span class="header-section-number">2.2</span> Fama-French data</a></li>
  <li><a href="#sec-orig" id="toc-sec-orig" class="nav-link" data-scroll-target="#sec-orig"><span class="header-section-number">2.3</span> Daily CRSP data – Tidy Finance version</a></li>
  <li><a href="#sec-ibis" id="toc-sec-ibis" class="nav-link" data-scroll-target="#sec-ibis"><span class="header-section-number">2.4</span> Daily CRSP data – Ibis/DuckDB version</a></li>
  <li><a href="#getting-original-data-tables" id="toc-getting-original-data-tables" class="nav-link" data-scroll-target="#getting-original-data-tables"><span class="header-section-number">2.5</span> Getting original data tables</a></li>
  <li><a href="#using-local-data-files" id="toc-using-local-data-files" class="nav-link" data-scroll-target="#using-local-data-files"><span class="header-section-number">2.6</span> Using local data files</a></li>
  <li><a href="#some-observations-on-using-python-versus-r" id="toc-some-observations-on-using-python-versus-r" class="nav-link" data-scroll-target="#some-observations-on-using-python-versus-r"><span class="header-section-number">2.7</span> Some observations on using Python versus R</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="crsp-daily-py.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Using DuckDB with WRDS: Python version</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ian D. Gow <a href="mailto:iandgow@gmail.com" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-6243-8409" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 23, 2025</p>
    </div>
  </div>
  
    
  </div>
  

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>Python</p>
  </div>
</div>

</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>In this note, I demonstrate how one can use the Ibis package in Python to get data from a PostgreSQL database and some advantages of using Ibis over a more traditional approach of using SQL to create Pandas data frames and then using Pandas for further data processing. As the working example, I focus on the creation of “daily CRSP data” as found in <a href="https://www.tidy-finance.org/python/wrds-crsp-and-compustat.html#daily-crsp-data"><em>Tidy Finance with Python</em></a>.</p>
<p>I show that using Ibis has a number of advantages over the approach used in Tidy Finance.</p>
<ul>
<li>Data retrieval is faster</li>
<li>The code used is simpler and more “Pythonic”</li>
<li>The code created with Ibis facilitates shifting from remote PostgreSQL data to a local data source (e.g., parquet files)</li>
<li>Working with the final data is a lot easier and more performant</li>
</ul>
<p>This note was written using <a href="https://quarto.org">Quarto</a> and compiled with <a href="https://posit.co/products/open-source/rstudio/">RStudio</a>, an integrated development environment (IDE) for working with R and, to some extent, Python. The source code for this note is available <a href="https://raw.githubusercontent.com/iangow/notes/main/crsp-daily-py.qmd">here</a> and the latest version of this PDF is <a href="https://raw.githubusercontent.com/iangow/notes/main/crsp-daily-py.pdf">here</a>.</p>
</section>
<section id="getting-data" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Getting data</h1>
<p><a href="https://www.tidy-finance.org/python/wrds-crsp-and-compustat.html#daily-crsp-data">Chapter 3</a> of <em>Tidy Finance with Python</em> describes the process for collecting daily stock data from CRSP and combining it with security-level data from CRSP and data on market performance from Fama-French.</p>
<p>The daily CRSP data set is one of two data sets used in <em>Tidy Finance with Python</em> that are large enough to create any concerns in terms of resources for working with those data (e.g., network bandwidth, storage, and RAM). This makes daily CRSP an excellent candidate for further analysis here.</p>
<section id="general-set-up" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="general-set-up"><span class="header-section-number">2.1</span> General set-up</h2>
<p>Because this note uses a number of different approaches to a set of problems, there are many packages I need to load:</p>
<div id="packages" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas_datareader <span class="im">as</span> pdr</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> timeit</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ibis</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ibis <span class="im">import</span> _</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> os.path <span class="im">import</span> join</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy <span class="im">import</span> create_engine</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> db2pq <span class="im">import</span> wrds_update_pq</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>I follow Tidy Finance in focusing on data for the year 1960 to 2023.</p>
<div id="date-range" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">"1960-01-01"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">"2023-12-31"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="fama-french-data" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="fama-french-data"><span class="header-section-number">2.2</span> Fama-French data</h2>
<p>To keep this note self-contained, here I include code to get the Fama-French data used below. Note that this code is similar to code included in the <a href="https://www.tidy-finance.org/python/accessing-and-managing-financial-data.html#fama-french-data">Chapter 2</a> of <em>Tidy Finance with Python</em>.</p>
<p>If you are a reader of <em>Tidy Finance with Python</em> and already have the SQLite database created by running the code in Chapter 2 of that book, you can skip ahead to <a href="#sec-orig" class="quarto-xref">Section&nbsp;2.3</a>.</p>
<div id="ff-data" class="cell" data-cache="true" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>factors_ff3_daily_raw <span class="op">=</span> pdr.DataReader(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  name<span class="op">=</span><span class="st">"F-F_Research_Data_Factors_daily"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  data_source<span class="op">=</span><span class="st">"famafrench"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  start<span class="op">=</span>start_date,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  end<span class="op">=</span>end_date)[<span class="dv">0</span>]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>factors_ff3_daily <span class="op">=</span> (factors_ff3_daily_raw</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  .divide(<span class="dv">100</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  .reset_index(names<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  .rename(<span class="bu">str</span>.lower, axis<span class="op">=</span><span class="st">"columns"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  .rename(columns<span class="op">=</span>{<span class="st">"mkt-rf"</span>: <span class="st">"mkt_excess"</span>})</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-connect-sqlite" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> Path(os.environ[<span class="st">"DATA_DIR"</span>]).expanduser()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>db_path <span class="op">=</span> data_dir <span class="op">/</span> <span class="st">"tidy_finance"</span> <span class="op">/</span> <span class="st">"tidy_finance_python.sqlite"</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(database<span class="op">=</span>db_path)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>factors_ff3_daily.to_sql(name<span class="op">=</span><span class="st">"factors_ff3_daily"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                         con<span class="op">=</span>tidy_finance,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                         if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                         index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="connect-sqlite" class="cell-output cell-output-display" data-execution_count="4">
<pre><code>16108</code></pre>
</div>
</div>
</section>
<section id="sec-orig" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="sec-orig"><span class="header-section-number">2.3</span> Daily CRSP data – Tidy Finance version</h2>
<p>Tidy Finance say “while [earlier data sets] can be downloaded in a meaningful amount of time, this is usually not true for daily return data. The daily CRSP data file is substantially larger than monthly data and can exceed 20 GB.””</p>
<p>Tidy Finance suggest that “this has two important implications: you cannot hold all the daily return data in your memory (hence it is not possible to copy the entire dataset to your local database), and in our experience, the download usually crashes (or never stops) because it is too much data for the WRDS cloud to prepare and send to your Python session.”</p>
<p>The solution proposed by Tidy Finance is to “split up the big task into several smaller tasks that are easier to handle.” The following code is more or less copy-pasted from <a href="https://www.tidy-finance.org/python/wrds-crsp-and-compustat.html#daily-crsp-data"><em>Tidy Finance with Python</em></a>. The main change I made was to increase the batch size from 500 to 2,000, as doing so has little impact on performance (for me), but reduces the lines of output.</p>
<p>Note that I omit the code used to set the <code>WRDS_USER</code> environment variable, but you can set that using code provided by Tidy Finance on <a href="https://www.tidy-finance.org/python/setting-up-your-environment.html">their website</a>.</p>
<div id="cell-crsp-daily-orig" class="cell" data-cache="true" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>tic <span class="op">=</span> timeit.default_timer()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>connection_string <span class="op">=</span> (</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"postgresql+psycopg2://"</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a> <span class="ss">f"</span><span class="sc">{</span>os<span class="sc">.</span>getenv(<span class="st">'WRDS_USER'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"@wrds-pgdata.wharton.upenn.edu:9737/wrds"</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>wrds <span class="op">=</span> create_engine(connection_string, pool_pre_ping<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>factors_ff3_daily <span class="op">=</span> pd.read_sql(</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  sql<span class="op">=</span><span class="st">"SELECT * FROM factors_ff3_daily"</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  con<span class="op">=</span>tidy_finance,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>permnos <span class="op">=</span> pd.read_sql(</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  sql<span class="op">=</span><span class="st">"SELECT DISTINCT permno FROM crsp.stksecurityinfohist"</span>,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  con<span class="op">=</span>wrds,</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  dtype<span class="op">=</span>{<span class="st">"permno"</span>: <span class="bu">int</span>}</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>permnos <span class="op">=</span> <span class="bu">list</span>(permnos[<span class="st">"permno"</span>].astype(<span class="bu">str</span>))</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">2000</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>batches <span class="op">=</span> np.ceil(<span class="bu">len</span>(permnos)<span class="op">/</span>batch_size).astype(<span class="bu">int</span>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, batches<span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  permno_batch <span class="op">=</span> permnos[</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    ((j<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span>batch_size):(<span class="bu">min</span>(j<span class="op">*</span>batch_size, <span class="bu">len</span>(permnos)))</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  permno_batch_formatted <span class="op">=</span> (</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">", "</span>.join(<span class="ss">f"'</span><span class="sc">{</span>permno<span class="sc">}</span><span class="ss">'"</span> <span class="cf">for</span> permno <span class="kw">in</span> permno_batch)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  permno_string <span class="op">=</span> <span class="ss">f"(</span><span class="sc">{</span>permno_batch_formatted<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  crsp_daily_sub_query <span class="op">=</span> (</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT dsf.permno, dlycaldt AS date, dlyret AS ret "</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>      <span class="st">"FROM crsp.dsf_v2 AS dsf "</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>      <span class="st">"INNER JOIN crsp.stksecurityinfohist AS ssih "</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>      <span class="st">"ON dsf.permno = ssih.permno AND "</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>         <span class="st">"ssih.secinfostartdt &lt;= dsf.dlycaldt AND "</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>         <span class="st">"dsf.dlycaldt &lt;= ssih.secinfoenddt "</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"WHERE dsf.permno IN </span><span class="sc">{</span>permno_string<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>           <span class="ss">f"AND dlycaldt BETWEEN '</span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss">' AND '</span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">' "</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">"AND ssih.sharetype = 'NS' "</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">"AND ssih.securitytype = 'EQTY' "</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">"AND ssih.securitysubtype = 'COM' "</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">"AND ssih.usincflg = 'Y' "</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">"AND ssih.issuertype in ('ACOR', 'CORP') "</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">"AND ssih.primaryexch in ('N', 'A', 'Q') "</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">"AND ssih.conditionaltype in ('RW', 'NW') "</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">"AND ssih.tradingstatusflg = 'A'"</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>  crsp_daily_sub <span class="op">=</span> (pd.read_sql_query(</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>      sql<span class="op">=</span>crsp_daily_sub_query,</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>      con<span class="op">=</span>wrds,</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>      dtype<span class="op">=</span>{<span class="st">"permno"</span>: <span class="bu">int</span>}</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    .dropna()</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>  crsp_daily_sub[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(crsp_daily_sub.date,</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>                                          <span class="bu">format</span><span class="op">=</span><span class="st">'%Y%m</span><span class="sc">%d</span><span class="st">%H%M%S'</span>)</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">not</span> crsp_daily_sub.empty:</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>      crsp_daily_sub <span class="op">=</span> (crsp_daily_sub</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>        .merge(factors_ff3_daily[[<span class="st">"date"</span>, <span class="st">"rf"</span>]],</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>               on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>          ret_excess <span class="op">=</span> <span class="kw">lambda</span> x:</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>            ((x[<span class="st">"ret"</span>] <span class="op">-</span> x[<span class="st">"rf"</span>]).clip(lower<span class="op">=-</span><span class="dv">1</span>))</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>        .get([<span class="st">"permno"</span>, <span class="st">"date"</span>, <span class="st">"ret_excess"</span>])</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> j <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>        if_exists_string <span class="op">=</span> <span class="st">"replace"</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>:</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>        if_exists_string <span class="op">=</span> <span class="st">"append"</span></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>      crsp_daily_sub.to_sql(</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"crsp_daily"</span>,</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>        con<span class="op">=</span>tidy_finance,</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>        if_exists<span class="op">=</span>if_exists_string,</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="va">False</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"Batch </span><span class="sc">{</span>j<span class="sc">}</span><span class="ss"> out of </span><span class="sc">{</span>batches<span class="sc">}</span><span class="ss"> done (</span><span class="sc">{</span>(j<span class="op">/</span>batches)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>toc <span class="op">=</span> timeit.default_timer()</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>toc <span class="op">-</span> tic</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Batch 1 out of 21 done (4.76%)
Batch 2 out of 21 done (9.52%)
Batch 3 out of 21 done (14.29%)
Batch 4 out of 21 done (19.05%)
Batch 5 out of 21 done (23.81%)
Batch 6 out of 21 done (28.57%)
Batch 7 out of 21 done (33.33%)
Batch 8 out of 21 done (38.10%)
Batch 9 out of 21 done (42.86%)
Batch 10 out of 21 done (47.62%)
Batch 11 out of 21 done (52.38%)
Batch 12 out of 21 done (57.14%)
Batch 13 out of 21 done (61.90%)
Batch 14 out of 21 done (66.67%)
Batch 15 out of 21 done (71.43%)
Batch 16 out of 21 done (76.19%)
Batch 17 out of 21 done (80.95%)
Batch 18 out of 21 done (85.71%)
Batch 19 out of 21 done (90.48%)
Batch 20 out of 21 done (95.24%)
Batch 21 out of 21 done (100.00%)</code></pre>
</div>
<div id="crsp-daily-orig" class="cell-output cell-output-display" data-execution_count="6">
<pre><code>473.0824100000318</code></pre>
</div>
</div>
<p>So the code takes about 5 minutes and the result is a table <code>crsp_daily</code> inside an SQLite database.</p>
</section>
<section id="sec-ibis" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="sec-ibis"><span class="header-section-number">2.4</span> Daily CRSP data – Ibis/DuckDB version</h2>
<p>I now generate the same data table, but using Ibis to connect to PostgreSQL instead of using the Python package <code>sqlachemy</code>, which in turn uses the <code>psycopg2</code> package. Note I could use Ibis with a PostgreSQL backend directly, but I instead use a DuckDB backend and (implicitly) use <a href="https://duckdb.org/docs/extensions/postgres">the <code>postgres</code> extension</a> for DuckDB to access PostgreSQL data within DuckDB. I say “implicitly” because the Ibis package is taking care of most of the details for me.</p>
<p>If you are working through this code interactively, you might find it helpful to set the following option:</p>
<div id="eadbbc8c" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ibis.options.interactive <span class="op">=</span> <span class="va">True</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="start-time-duckdb" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>tic <span class="op">=</span> timeit.default_timer()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>I begin by connecting to an in-memory DuckDB database, which is created with the following command:</p>
<div id="connect-duckdb" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>con <span class="op">=</span> ibis.duckdb.<span class="ex">connect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Rather than loading the <code>factors_ff3_daily</code> data from the SQLite database into a Pandas data frame, I load it into my DuckDB database. The following code is very similar to the above apart from the use of <code>con.read_sqlite()</code> in place of <code>pd.read_sql()</code>.</p>
<div id="load-ff" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>factors_ff3_daily <span class="op">=</span> con.read_sqlite(db_path, table_name<span class="op">=</span><span class="st">"factors_ff3_daily"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Again rather than connecting to the WRDS PostgreSQL database directly using <code>sqlalchemy</code>, I connect via my DuckDB database. Note that this requires a <em>slightly</em> different form for the URI (i.e., <code>postgres://</code> in place of <code>postgresql+psycopg2://</code>) and using <code>con.read_postgres()</code> in place of <code>pd.read_sql()</code>.</p>
<div id="wrds-uri" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>wrds_uri <span class="op">=</span> (</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"postgres://"</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a> <span class="ss">f"</span><span class="sc">{</span>os<span class="sc">.</span>getenv(<span class="st">'WRDS_USER'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"@wrds-pgdata.wharton.upenn.edu:9737/wrds"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="connect-pg" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dsf <span class="op">=</span> con.read_postgres(wrds_uri,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                        table_name<span class="op">=</span><span class="st">"dsf_v2"</span>, database<span class="op">=</span><span class="st">"crsp"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>ssih <span class="op">=</span> con.read_postgres(wrds_uri,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                         table_name<span class="op">=</span><span class="st">"stksecurityinfohist"</span>, database<span class="op">=</span><span class="st">"crsp"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now the <em>pièce de résistance</em>: I create <code>crsp_daily</code> using the following code. There are a few things to note about this code. First, creating it involves fairly trivial translation of the SQL above. For example, <code>ssih.issuertype IN ('ACOR', 'CORP')</code> becomes the more Pythonic <code>ssih.issuertype.isin(['ACOR', 'CORP'])</code> and <code>ssih.securitytype = 'EQTY'</code> sees the SQL equality operator replaced by the Pythonic <code>==</code>. But if you can read the SQL, you should be able to understand this code quite easily.</p>
<p>Note that the code above used Pandas to do some calculations that could have been performed using SQL. Specifically, the <code>.clip(lower=-1)</code> could be <code>CASE WHEN ret_excess &lt; -1 THEN -1 ELSE ret_excess</code> and the <code>(_.ret_excess &lt; -1).ifelse(-1, _.ret_excess))</code> is actually implemented by Ibis in this way.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div id="crsp-daily-duckdb" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>crsp_daily <span class="op">=</span> (</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  dsf</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  .inner_join(ssih, <span class="st">"permno"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  .<span class="bu">filter</span>(ssih.secinfostartdt <span class="op">&lt;=</span> dsf.dlycaldt,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>          dsf.dlycaldt <span class="op">&gt;=</span> start_date,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>          dsf.dlycaldt <span class="op">&lt;=</span> end_date,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>          ssih.sharetype <span class="op">==</span> <span class="st">'NS'</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>          ssih.securitytype <span class="op">==</span> <span class="st">'EQTY'</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>          ssih.securitysubtype <span class="op">==</span> <span class="st">'COM'</span>,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>          ssih.usincflg <span class="op">==</span> <span class="st">'Y'</span>,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>          ssih.issuertype.isin([<span class="st">'ACOR'</span>, <span class="st">'CORP'</span>]),</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>          ssih.primaryexch.isin([<span class="st">'N'</span>, <span class="st">'A'</span>, <span class="st">'Q'</span>]),</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>          ssih.conditionaltype.isin([<span class="st">'RW'</span>, <span class="st">'NW'</span>]),</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>          ssih.tradingstatusflg <span class="op">==</span> <span class="st">'A'</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  .rename(date<span class="op">=</span><span class="st">"dlycaldt"</span>, ret<span class="op">=</span><span class="st">"dlyret"</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  .left_join(factors_ff3_daily, <span class="st">"date"</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  .mutate(ret_excess <span class="op">=</span> _.ret <span class="op">-</span> _.rf)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  .mutate(ret_excess <span class="op">=</span> (_.ret_excess <span class="op">&lt;</span> <span class="op">-</span><span class="dv">1</span>).ifelse(<span class="op">-</span><span class="dv">1</span>, _.ret_excess))</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  .select(<span class="st">"permno"</span>, <span class="st">"date"</span>, <span class="st">"ret_excess"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Rather than “downgrading” the data to an SQLite table, I will just export the data to a parquet file.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div id="crsp-daily-pq" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>crsp_daily.to_parquet(join(data_dir, <span class="st">"tidy_finance"</span>, <span class="st">"crsp_daily.parquet"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="621d902b" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>toc <span class="op">=</span> timeit.default_timer()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Elapsed time: </span><span class="sc">{</span>(toc <span class="op">-</span> tic)<span class="sc">:.2f}</span><span class="ss"> seconds."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Elapsed time: 109.46 seconds.</code></pre>
</div>
</div>
<p>So one benefit is seen immediately: the code runs in about 2 minutes, or about 2.5 times faster than the original Tidy Finance code. A second benefit is that the code is much simpler (and shorter). There is no need to create <code>permnos</code>, run a <code>for</code>-loop, specify batch sizes, or blend SQL with Python variables using <a href="https://docs.python.org/3/tutorial/inputoutput.html"><strong>f-strings</strong></a>. A final benefit is that this code is more versatile, which we illustrate in a moment.</p>
<p>While we don’t need <code>permnos</code> here, we could create it easily using the following code:</p>
<div id="get-permnos-db" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>permnos <span class="op">=</span> (ssih</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  .select(<span class="st">"permno"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  .distinct()</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  .to_pandas())</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>permnos <span class="op">=</span> <span class="bu">list</span>(permnos[<span class="st">"permno"</span>].astype(<span class="bu">str</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="getting-original-data-tables" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="getting-original-data-tables"><span class="header-section-number">2.5</span> Getting original data tables</h2>
<p>Rather than creating a special local “daily CRSP” file, we could instead get and retain the original data files. An advantage of this approach is that it means we can write code that creates data tables directly off WRDS data files without requiring minutes to compute.</p>
<p>I have used two main approaches to maintaining a local data repository:</p>
<ol type="1">
<li><p>PostgreSQL database. In 2011, long before WRDS had its own PostgreSQL database, I wrote Perl scripts to export data from SAS files on the WRDS server to tables in a local PostgreSQL database. These Perl scripts eventually became the <code>wrds2pg</code> Python package.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> I wrote more about creating such a database in <a href="https://iangow.github.io/far_book/postgresql.html">Appendix D</a> of <em>Empirical Research in Accounting: Tools and Methods</em>.]</p></li>
<li><p>Folders of parquet files. More recently I have used a local repository of parquet files as an alternative to the WRDS PostgreSQL database. While I have more about creating such a repository in <a href="https://iangow.github.io/far_book/parquet-wrds.html">Appendix E</a> of <em>Empirical Research in Accounting: Tools and Methods</em>, here I discuss how we can get just the two files we need from WRDS for our current exercise. This requires just the function <code>wrds_update_pq()</code> from my Python package <code>db2pq</code>.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p></li>
</ol>
<div id="96ffb01a" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> db2pq <span class="im">import</span> wrds_update_pq</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The <code>wrds_update_pq()</code> function keys off the environment variable <code>DATA_DIR</code> and stores WRDS tables as files organized into directories that match the schemas in the WRDS PostgreSQL database. I start by getting <code>crsp.dsf_v2</code>, which is about 29 GB in SAS form and 24 GB in PostgreSQL form on the WRDS servers. As can be seen, getting <code>crsp.dsf_v2</code> requires a single line of code.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<div id="86b5dfa8" class="cell" data-cache="true" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>tic <span class="op">=</span> timeit.default_timer()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>wrds_update_pq(<span class="st">"dsf_v2"</span>, schema<span class="op">=</span><span class="st">'crsp'</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>toc <span class="op">=</span> timeit.default_timer()</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Elapsed time: </span><span class="sc">{</span>(toc <span class="op">-</span> tic)<span class="sc">:.2f}</span><span class="ss"> seconds."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>crsp.dsf_v2 already up to date.
Elapsed time: 0.42 seconds.</code></pre>
</div>
</div>
<p>It takes me about 22 minutes to get the data.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> The resulting parquet file is 4.35 GB due to the compression and efficient storage offered by the parquet format. This compares not too favourably with the 2.7 GB for an SQLite database containing just these two tables, which is a cut-down version of the data created by Tidy Finance to save on space.</p>
<p>Note that the <code>wrds_update_pq()</code> checks the “last updated” value for the SAS data file on WRDS and compares that with the corresponding metadata in any parquet file in the existing location and only gets data from the PostgreSQL server if the last updated value has changed. The WRDS subscription at my institution only offers annual updates, to the 20-minute download of <code>crsp.dsf_v2</code> only needs to happen once a year. Another feature of <code>wrds_update_pq()</code> from the <code>db2pq</code> package is that I wrote it to be very sparing in its use of RAM in creating the parquet file.</p>
<p>Getting <code>crsp.stksecurityinfohist</code> takes only a few seconds because the underlying data table is much smaller.</p>
<div id="581f04ba" class="cell" data-cache="true" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>tic <span class="op">=</span> timeit.default_timer()</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>wrds_update_pq(<span class="st">"stksecurityinfohist"</span>, schema<span class="op">=</span><span class="st">"crsp"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>toc <span class="op">=</span> timeit.default_timer()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Elapsed time: </span><span class="sc">{</span>(toc <span class="op">-</span> tic)<span class="sc">:.2f}</span><span class="ss"> seconds."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>crsp.stksecurityinfohist already up to date.
Elapsed time: 0.36 seconds.</code></pre>
</div>
</div>
</section>
<section id="using-local-data-files" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="using-local-data-files"><span class="header-section-number">2.6</span> Using local data files</h2>
<p>So now that I have local copies of <code>crsp.dsf_v2</code> and <code>crsp.stksecurityinfohist</code>, I can use those rather than going back to the WRDS PostgreSQL server to get data every time. Much of the code is unchanged from that in <a href="#sec-ibis" class="quarto-xref">Section&nbsp;2.4</a>.</p>
<div id="connect-duckdb-again" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>tic <span class="op">=</span> timeit.default_timer()</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>con <span class="op">=</span> ibis.duckdb.<span class="ex">connect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="load-ff-again" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>factors_ff3_daily <span class="op">=</span> con.read_sqlite(db_path, table_name<span class="op">=</span><span class="st">"factors_ff3_daily"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The only real difference in the code is in the lines creating <code>dsf</code> and <code>ssih</code>. Before I used <code>con.read_postgres()</code> to connect to the WRDS PostgreSQL server. Now I use <code>con.read_parquet()</code> to connect to local copies in parquet form.</p>
<div id="data-load-local" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.environ[<span class="st">"DATA_DIR"</span>]</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>dsf <span class="op">=</span> con.read_parquet(join(data_dir, <span class="st">"crsp"</span>, <span class="st">"dsf_v2.parquet"</span>))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>ssih <span class="op">=</span> con.read_parquet(join(data_dir, <span class="st">"crsp"</span>, <span class="st">"stksecurityinfohist.parquet"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The following code is identical to the code in <a href="#sec-ibis" class="quarto-xref">Section&nbsp;2.4</a>. But now it takes 3 or 4 seconds to run rather than the 120 or so seconds needed earlier.</p>
<div id="crsp-daily-local" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>crsp_daily <span class="op">=</span> (</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  dsf</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  .inner_join(ssih, <span class="st">"permno"</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  .<span class="bu">filter</span>(ssih.secinfostartdt <span class="op">&lt;=</span> dsf.dlycaldt,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>          dsf.dlycaldt <span class="op">&gt;=</span> start_date,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>          dsf.dlycaldt <span class="op">&lt;=</span> end_date,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>          ssih.sharetype <span class="op">==</span> <span class="st">'NS'</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>          ssih.securitytype <span class="op">==</span> <span class="st">'EQTY'</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>          ssih.securitysubtype <span class="op">==</span> <span class="st">'COM'</span>,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>          ssih.usincflg <span class="op">==</span> <span class="st">'Y'</span>,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>          ssih.issuertype.isin([<span class="st">'ACOR'</span>, <span class="st">'CORP'</span>]),</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>          ssih.primaryexch.isin([<span class="st">'N'</span>, <span class="st">'A'</span>, <span class="st">'Q'</span>]),</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>          ssih.conditionaltype.isin([<span class="st">'RW'</span>, <span class="st">'NW'</span>]),</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>          ssih.tradingstatusflg <span class="op">==</span> <span class="st">'A'</span>)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  .rename(date<span class="op">=</span><span class="st">"dlycaldt"</span>, ret<span class="op">=</span><span class="st">"dlyret"</span>)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  .left_join(factors_ff3_daily, <span class="st">"date"</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  .mutate(ret_excess <span class="op">=</span> _.ret <span class="op">-</span> _.rf)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  .mutate(ret_excess <span class="op">=</span> (_.ret_excess <span class="op">&lt;</span> <span class="op">-</span><span class="dv">1</span>).ifelse(<span class="op">-</span><span class="dv">1</span>, _.ret_excess))</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  .select(<span class="st">"permno"</span>, <span class="st">"date"</span>, <span class="st">"ret_excess"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="crsp-daily-pq-again" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>crsp_daily.to_parquet(join(data_dir, <span class="st">"tidy_finance"</span>, <span class="st">"crsp_daily_alt.parquet"</span>))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>toc <span class="op">=</span> timeit.default_timer()</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Elapsed time: </span><span class="sc">{</span>(toc <span class="op">-</span> tic)<span class="sc">:.2f}</span><span class="ss"> seconds."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Elapsed time: 1.76 seconds.</code></pre>
</div>
</div>
<p>While the field I know best—empirical accounting research—seems to be somewhere between uninterested and hostile to ideas of reproducibility (perhaps because of the implications for the p-hacking that dominates the field), readers of Tidy Finance are more likely to be in finance, which seems to be embracing reproducibility more enthusiastically. Being able to run code quite quickly (e.g., against local parquet files) that can be then passed along to a data editor who can run the same code against a standard data set (e.g., against the WRDS PostgreSQL server) has a lot to recommend it.</p>
</section>
<section id="some-observations-on-using-python-versus-r" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="some-observations-on-using-python-versus-r"><span class="header-section-number">2.7</span> Some observations on using Python versus R</h2>
<p>In some ways this note covers ground explored in <a href="https://github.com/iangow/notes/blob/main/crsp_daily_benchmark.pdf">an earlier note that used R</a>. My impression is that some data analysts perceive Python to be somehow cooler and its users to be smarter than is the case for R, and <em>a fortiori</em> for the Tidyverse. But I believe this thinking is misguided.</p>
<p>In a lot of ways doing data analysis with the Tidyverse is more facile than doing the same with Python.</p>
<ul>
<li><p>The Tidyverse feels snappier than Ibis. In situations where there is very little latency with remote data frames using <code>dplyr</code> (actually <code>dbplyr</code> behind the scenes), the Ibis equivalents would take a few seconds to generate. While not a huge deal, I feel that building queries up using <code>dplyr</code> is probably a better way of writing SQL for many users and this snappiness adds to the quality of life for a data analyst.</p></li>
<li><p>At times the Tidyverse code is a little less clunky to write and look at. <strong>Non-standard evaluation</strong> means I can write <code>select(permno, date, ret_excess)</code> instead of <code>select("permno", "date", "ret_excess")</code> and <code>mutate(ret_excess = ret - rf)</code> instead of <code>from ibis import _</code> followed by <code>mutate(ret_excess = _.ret- _.rf)</code>.</p></li>
<li><p>Better workflow for creating documents. Python seems to work best with notebooks. Others have spoken about problems with notebooks (e.g., <a href="https://www.youtube.com/watch?v=7jiPeIFXb6U">a YouTube presentation by Joel Grus</a>). I think my issues are related, but are due more to my coming from a different workflow based on Quarto. In the “Quarto workflow” (as I use it), there is a clear distinction between source code and output. This is particularly clear when committing edits using Git.</p>
<p>I don’t like how output and source code get mixed up in Jupyter notebooks. While one can write scripts to scrub output from notebooks before committing them, at some point it can be useful to have output committed to Git as well. Spliting the source code (<code>.qmd</code>) and output (say, <code>.pdf</code>) into two documents solves this problem.</p>
<p>Some aspects of my Quarto-oriented workflow did not carry over from R to Python. For example, <code>knitr</code> (the package used in compiling R-based Quarto documents) offers caching at the level of a code chunk, while Jupyter appears to only offer document-level caching. This means I can tweak small portions of the R code without triggering costly recalculations. One solution to this problem in Python would be to switch to more of an interactive notebook-based approach, but this introduces all the issues raised by Joel Grus (e.g., I need to be thinking about what code I’ve run previously in a sesssion).</p></li>
<li><p>Better learning curve. A data analyst learning Python probaly starts out with Pandas. Moving up to larger data sets probably means learning a new language (e.g., SQL) or at least a new package (e.g., Ibis). In contrast, I think that a data analyst starting with R would learn Tidyverse approaches using local data frames and then “move up” to using <code>dbplyr</code> using remote data frames. That’s exactly the progression I use in <em>Empirical Research in Accounting: Tools and Methods</em>: from the introduction in <a href="https://iangow.github.io/far_book/r-intro.html">Chapter 2</a> through to the introduction to remote data frames in <a href="https://iangow.github.io/far_book/fin-state.html">Chapter 6</a>, there is barely a shift in gears.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
<p>In terms of languages, learning Pandas might be like learning Italian and then moving onto French when learning Ibis (SQL is German?). In contrast, knowing <code>dplyr</code> is like being a native speaker of American English when it comes to moving to <code>dbplyr</code> (standard British English). A few words are different, but you can understand pretty much everything and quickly start calling the local currency “pounds” not “dollars”.</p></li>
<li><p>R is more purpose-built for data analysis. In both R and Python, there are the age-old issues of dependencies and code that works with one version of a package, but not another. But these issues seem heightened with Python. In writing <em>Empirical Research in Accounting: Tools and Methods</em> over several years, I would occasionally come across code that needed updating to work with the latest version or inconsistencies between packages (e.g., for a time, one package required an older version of another). But these issues seem to have diminished over time as (for example) the Tidyverse has matured and become quite stable. And my impression is that these issues are more acute with Python.</p>
<p>Almost any resource on Python will talk about setting up virtual environments and how to deal with multiple versions of Python on your computer. I feel that R is easier to navigate for the more casual user who wants to run an analysis and isn’t looking to put code into a production system or into a time capsule. One <em>can</em> worry about these things, but I think that one has much less need to do so with R. Roughly 99% of the time one can have just use system-level versions of packages that are whatever is the latest on CRAN. For one there’s no worry about messing up the “system version” of R as there is with Python.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p></li>
</ul>
<p>Note that the above is by no means meant to claim that R is uniformly superior to Python, but simply that R has advantages and that these advantages are greater in certain situations. While I have never taken a course in computer science or data analysis, I have experience with both R and Python and find myself reaching for R in many cases and for Python in other cases. Sometimes I might use Python for one part of a problem and R for another part.</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Note that “clipping” the excess returns in this way has no justification in financial economics. <em>Excess</em> returns are not bounded by -1 in the way that returns on unleveraged long positions in limited-liability securities are. I implement this here to be consistent with Tidy Finance and also to illustrate how this can be done using Ibis.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>I have written on the topic of creating a repository of Parquet data files in <a href="https://iangow.github.io/far_book/parquet-wrds.html">Appendix E</a> of <em>Empirical Research in Accounting: Tools and Methods</em>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Run <code>pip install wrds2pg</code> to install this package.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Run <code>pip install db2pq</code> to install this package.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>The lines around this line are there just to record the time needed to do this.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>This is on a MacBook Pro with M1 Pro chip and a 1 Gbps internet connection.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>In this regard, I strongly disagree with <a href="https://www.economist.com/graphic-detail/2024/12/18/off-the-charts-newsletter-why-r-is-the-best-coding-language-for-data-journalism">the recommendation</a> of Philipp Hauber, a data scientist at <em>The Economist</em>, to start with the “no-frills tutorial by Norm Matloff” given the orientation of that resource to “base R”. I think <em>Empirical Research in Accounting: Tools and Methods</em> demonstrates that you can go quite far with very little base R–specific knowledge.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>Though MacOS, for one, makes this kind of problem much harder to cause than it used to be.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>