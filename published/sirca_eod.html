<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ian D. Gow">
<meta name="dcterms.date" content="2025-09-11">

<title>SIRCA ASX End of Day (EOD) collection – notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-5b4ad623e5705c0698d39aec6f10cf02.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#getting-sirca-asx-eof-data" id="toc-getting-sirca-asx-eof-data" class="nav-link" data-scroll-target="#getting-sirca-asx-eof-data">Getting SIRCA ASX EOF data</a></li>
  <li><a href="#examples" id="toc-examples" class="nav-link" data-scroll-target="#examples">Examples</a>
  <ul class="collapse">
  <li><a href="#finding-gcodes-from-company-names-or-ticker-codes" id="toc-finding-gcodes-from-company-names-or-ticker-codes" class="nav-link" data-scroll-target="#finding-gcodes-from-company-names-or-ticker-codes">1. Finding <code>gcodes</code> from company names or ticker codes</a></li>
  <li><a href="#adjusting-for-the-effects-of-corporate-actions" id="toc-adjusting-for-the-effects-of-corporate-actions" class="nav-link" data-scroll-target="#adjusting-for-the-effects-of-corporate-actions">2. Adjusting for the effects of corporate actions</a></li>
  <li><a href="#plotting-a-distribution-of-price-relatives-for-a-security" id="toc-plotting-a-distribution-of-price-relatives-for-a-security" class="nav-link" data-scroll-target="#plotting-a-distribution-of-price-relatives-for-a-security">3. Plotting a distribution of price relatives for a security</a></li>
  <li><a href="#dayssince-column" id="toc-dayssince-column" class="nav-link" data-scroll-target="#dayssince-column">4. <code>dayssince</code> column</a></li>
  <li><a href="#using-the-seniorsecurity-column" id="toc-using-the-seniorsecurity-column" class="nav-link" data-scroll-target="#using-the-seniorsecurity-column">5. Using the <code>seniorsecurity</code> column</a></li>
  <li><a href="#sec-neg-fct" id="toc-sec-neg-fct" class="nav-link" data-scroll-target="#sec-neg-fct">6. Negative <code>factor</code> values and zero <code>volumeonmkt</code> values</a></li>
  <li><a href="#calculating-a-cumulative-factor-excluding-dividends" id="toc-calculating-a-cumulative-factor-excluding-dividends" class="nav-link" data-scroll-target="#calculating-a-cumulative-factor-excluding-dividends">7. Calculating a cumulative factor excluding dividends</a></li>
  <li><a href="#segmentation-by-trade-type" id="toc-segmentation-by-trade-type" class="nav-link" data-scroll-target="#segmentation-by-trade-type">8. Segmentation by trade type</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="sirca_eod.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">SIRCA ASX End of Day (EOD) collection</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Australia</div>
    <div class="quarto-category">SIRCA</div>
    <div class="quarto-category">ASX</div>
    <div class="quarto-category">CSV</div>
    <div class="quarto-category">Parquet</div>
    <div class="quarto-category">dbplyr</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ian D. Gow <a href="mailto:iandgow@gmail.com" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-6243-8409" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">11 September 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview" class="level1">
<h1>Overview</h1>
<p>SIRCA’s ASX EOD (end of day) collection provides daily prices for ASX-listed companies and facilitates reliable measurement of security returns, with all data being retained for delisted companies. This note, based on SIRCA’s own <code>Guide to ASX End of Day Prices.pdf</code>, provides an introduction to the SIRCA ASX EOD collection.</p>
<p>The SIRCA ASX EOD collection includes the tables listed in <a href="#tbl-asx-eod-keys" class="quarto-xref">Table&nbsp;1</a>. More details can be found in my separate document on importing SIRCA ASX EOF data <a href="https://github.com/iangow/notes/blob/main/import_sirca.pdf">here</a>.</p>
<div id="tbl-asx-eod-keys" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-asx-eod-keys-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: SIRCA ASX EOD price collections
</figcaption>
<div aria-describedby="tbl-asx-eod-keys-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 34%">
<col style="width: 22%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th>Table</th>
<th>Description</th>
<th style="text-align: right;">Primary key</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>si_au_ref_names</code></td>
<td>Name and ticker histories for listed companies from January 2000</td>
<td style="text-align: right;"><code>gcode</code>, <code>securityticker</code>, <code>listdate</code></td>
</tr>
<tr class="even">
<td><code>si_au_prc_daily</code></td>
<td>Complete daily price, volume and value histories</td>
<td style="text-align: right;"><code>gcode</code>, <code>date</code>, <code>seniorsecurity</code></td>
</tr>
<tr class="odd">
<td><code>si_au_retn_mkt</code></td>
<td>Daily value- and equal-weighted whole market returns</td>
<td style="text-align: right;"><code>date</code></td>
</tr>
<tr class="even">
<td><code>si_au_ref_trddays</code></td>
<td>Record of ASX trading dates since January 2000</td>
<td style="text-align: right;"><code>date</code></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>All company names and ticker codes are recorded in a separate table—<code>si_au_ref_names</code>—which links names and tickers through time with a permanent “group code” identifier created by SIRCA named <code>gcode</code>. SIRCA designed <code>gcode</code> to allow users to build price and return series for series for a company’s shares over time even if its ticker code changes. The same <code>gcodes</code> are used across a number of SIRCA’s data sets.</p>
<p>he <code>si_au_prc_daily</code> table includes all end-of-day trade prices for the equity securities of all ASX companies starting from January 2000. This table also includes dividend and franking events; capital returns; adjustments for numerous corporate action events, such as splits, consolidation, bonus issues, renounceable and non-renounceable issues; and total daily traded volume and value; and, the number of issued shares.</p>
<p>Other components of the SIRCA ASX EOD library are <code>si_au_retn_mkt</code> which provides value- and equal-weighted all-of-market daily returns, which SIRCA generates from all observable daily company returns.</p>
<p>SIRCA provides <code>si_au_ref_trdday</code>, which identifies all ASX trading days since the start of January 2000 and can be used to identify gaps in company price series, from suspensions or thin trading.</p>
<p>Finally SIRCA provides a detailed description of all tables and fields in a data dictionary.</p>
<p>While this note is based on SIRCA’s own <code>Guide to ASX End of Day Prices.pdf</code>, it goes beyond that guide in a number of respects. First, I provide detailed instructions on preparing the SIRCA ASX EOD data for use and illustrate analysis using DuckDB and parquet files, a high-performance state-of-the-art approach to data analysis. The SIRCA guide assumes that the user has access to an SQL database containing the four tables listed in <a href="#tbl-asx-eod-keys" class="quarto-xref">Table&nbsp;1</a>, but provides no guidance on creating that database.</p>
<p>Second, I provide output—both tables and graphs—for the example queries provided here. While the SIRCA guide describes observed patterns, it does not provide the output from its queries.</p>
<p>Third, I expand on or refine the queries used in the SIRCA guide. For example, where the SIRCA guide suggests the use of <code>dayssince</code> variables to identify non-trading days, I propose a more robust approach.</p>
<p>The code in this note uses the packages listed below, plus the <code>duckdb</code> package.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> This note was written using <a href="https://quarto.org">Quarto</a> and compiled with <a href="https://posit.co/products/open-source/rstudio/">RStudio</a>, an integrated development environment (IDE) for working with R. The source code for this note is available <a href="https://raw.githubusercontent.com/iangow/notes/main/sirca_eod.qmd">here</a> and the latest PDF version is available <a href="https://raw.githubusercontent.com/iangow/notes/main/sirca_eod.pdf">here</a>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dbplyr, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(farr)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="getting-sirca-asx-eof-data" class="level1">
<h1>Getting SIRCA ASX EOF data</h1>
<p>SIRCA supplies the data we will use as four compressed CSV files. The original SIRCA note assumes that you have processed the data into an SQL database, but does not provide any details for doing this. In contrast, I provide the code needed to prepare the data for the analysis below. I merely assume that you have access to SIRCA and have downloaded the raw data from SIRCA along the lines discussed below.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Once you have done that you should be able to execute all the code in this note and thereby produce all the output (tables and graphs) contained herein.</p>
<p>You should download these files and place them <em>as is</em> in a single <code>sirca</code> directory and you should edit the code below to tell my script where to look for that directory.</p>
<p>In my case, <code>sirca</code> is found in <code>~/Dropbox/raw_data</code> and so I execute the following command in RStudio:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">RAW_DATA_DIR =</span> <span class="st">"~/Dropbox/raw_data"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="#tbl-csv-files" class="quarto-xref">Table&nbsp;2</a> provides details on the contents of the <code>sirca</code> subdirectory of <code>RAW_DATA_DIR</code> on my computer.</p>
<div class="cell">
<div id="tbl-csv-files" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-csv-files-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Data on supplied CSV files from SIRCA
</figcaption>
<div aria-describedby="tbl-csv-files-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">file_name</th>
<th style="text-align: left;">size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Delisted_MergerAndAcquisition-2025-08.csv.gz</td>
<td style="text-align: left;">14.29 kB</td>
</tr>
<tr class="even">
<td style="text-align: left;">MergerAndAcquisition-2025-08.csv.gz</td>
<td style="text-align: left;">18.95 kB</td>
</tr>
<tr class="odd">
<td style="text-align: left;">si_au_prc_daily.csv.gz</td>
<td style="text-align: left;">387.72 MB</td>
</tr>
<tr class="even">
<td style="text-align: left;">si_au_ref_names.csv.gz</td>
<td style="text-align: left;">591.84 kB</td>
</tr>
<tr class="odd">
<td style="text-align: left;">si_au_ref_trddays.csv.gz</td>
<td style="text-align: left;">62.15 kB</td>
</tr>
<tr class="even">
<td style="text-align: left;">si_au_retn_mkt.csv.gz</td>
<td style="text-align: left;">366.14 kB</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SIRCA EOD Data Dictionary.xlsx</td>
<td style="text-align: left;">175.11 kB</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The script also needs to know where to put the processed data files, which will be in parquet format. You should edit the following line to refer to a location on <em>your</em> computer that you would like to use to store processed SIRCA data.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">DATA_DIR =</span> <span class="st">"~/Dropbox/pq_data"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>With the needed packages installed, and <code>RAW_DATA_DIR</code> and <code>DATA_DIR</code> set, we can run the script to process the SIRCA raw data with the following line. On my computer, this script takes about 6 seconds to run. If you wish to learn more about what the script is doing, please see the separate document on importing SIRCA ASX EOF data <a href="https://github.com/iangow/notes/blob/main/import_sirca.pdf">here</a>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"https://raw.githubusercontent.com/iangow/notes/main/import_sirca.R"</span>, </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">echo =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system.time</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
 24.218   2.029   5.905 </code></pre>
</div>
</div>
<p>Details on the resulting parquet files that I have on my computer are provided in <a href="#tbl-pq-files" class="quarto-xref">Table&nbsp;3</a>.</p>
<div class="cell">
<div id="tbl-pq-files" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-pq-files-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Data on processed parquet files
</figcaption>
<div aria-describedby="tbl-pq-files-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">file_name</th>
<th style="text-align: left;">size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ann_fin.parquet</td>
<td style="text-align: left;">78.75 MB</td>
</tr>
<tr class="even">
<td style="text-align: left;">asic_short_interest.parquet</td>
<td style="text-align: left;">27.39 MB</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Icon</td>
<td style="text-align: left;">0 B</td>
</tr>
<tr class="even">
<td style="text-align: left;">ma_anz_company.parquet</td>
<td style="text-align: left;">843.87 kB</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ma_anz_fdmt_auditfees.parquet</td>
<td style="text-align: left;">595.9 kB</td>
</tr>
<tr class="even">
<td style="text-align: left;">si_au_prc_daily.parquet</td>
<td style="text-align: left;">517.22 MB</td>
</tr>
<tr class="odd">
<td style="text-align: left;">si_au_ref_names.parquet</td>
<td style="text-align: left;">838.61 kB</td>
</tr>
<tr class="even">
<td style="text-align: left;">si_au_ref_trddays.parquet</td>
<td style="text-align: left;">86.75 kB</td>
</tr>
<tr class="odd">
<td style="text-align: left;">si_au_retn_mkt.parquet</td>
<td style="text-align: left;">439.38 kB</td>
</tr>
<tr class="even">
<td style="text-align: left;">si_ms_ma.parquet</td>
<td style="text-align: left;">63.16 kB</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="examples" class="level1">
<h1>Examples</h1>
<p>The following examples demonstrate how to do certain analyses using the SIRCA ASX EOD data. These examples are based on examples provide in the SIRCA guide. Specifically, I show how one can use the SIRCA ASX EOD collection to do the following analyses:</p>
<ol type="1">
<li>Find a <code>gcode</code> from a company’s name or ticker code</li>
<li>Apply the <code>cumulativefactor</code> field to adjust prices for different dividend and corporate action events</li>
<li>Generate and plot total shareholder returns</li>
<li>Use the <code>dayssince</code> column to identify return intervals between consecutive trades</li>
<li>Use the <code>seniorsecurity</code> column to focus on the residual risk security for each company</li>
<li>Handle negative factors and zero volumes</li>
<li>Calculate a cumulative factor excluding dividends</li>
<li>Segment trading activity by trade type and venue</li>
</ol>
<p>All of the examples here use an in-memory DuckDB database connection. The following code creates this database connection and reads in three of the four SIRCA ASX EOD tables. In the cases of <code>si_au_ref_names</code>, the code also names that table so that we can refer to it using SQL written “by hand”.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>())</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>si_au_ref_names <span class="ot">&lt;-</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load_parquet</span>(db, <span class="st">"si_au_ref_names"</span>, <span class="st">"sirca"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compute</span>(<span class="at">name =</span> <span class="st">"si_au_ref_names"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="ot">&lt;-</span> <span class="fu">load_parquet</span>(db, <span class="st">"si_au_prc_daily"</span>, <span class="st">"sirca"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>si_au_ref_trddays <span class="ot">&lt;-</span> <span class="fu">load_parquet</span>(db, <span class="st">"si_au_ref_trddays"</span>, <span class="st">"sirca"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="finding-gcodes-from-company-names-or-ticker-codes" class="level2">
<h2 class="anchored" data-anchor-id="finding-gcodes-from-company-names-or-ticker-codes">1. Finding <code>gcodes</code> from company names or ticker codes</h2>
<p>One way of searching for a <code>gcode</code> is to look up the company name. For example, we could search for every <code>gcode</code> with a company name including <code>WESTPAC</code>. Because we specified <code>compute(name = "si_au_ref_names")</code>, we can refer to that table in SQL like the following:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> gcode, seniorsecurity, securityticker, abbrevcompanyname</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> si_au_ref_names</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> fullcompanyname <span class="kw">LIKE</span> <span class="st">'%WESTPAC%'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-wbc-sql" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-wbc-sql-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Securities matching <code>WESTPAC</code>: SQL
</figcaption>
<div aria-describedby="tbl-wbc-sql-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: right;">seniorsecurity</th>
<th style="text-align: left;">securityticker</th>
<th style="text-align: left;">abbrevcompanyname</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">wbc1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">WBC</td>
<td style="text-align: left;">WESTPAC BANKING CORP</td>
</tr>
<tr class="even">
<td style="text-align: left;">wot1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">WOTCA</td>
<td style="text-align: left;">WESTPAC OFFICE TRUST</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wot1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">WOT</td>
<td style="text-align: left;">WESTPAC OFFICE TRUST</td>
</tr>
<tr class="even">
<td style="text-align: left;">wpt1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">WPT</td>
<td style="text-align: left;">WESTPAC PROP. TRUST</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>However, the same query could be run using <code>tidyverse</code> code:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>si_au_ref_names <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_like</span>(fullcompanyname, <span class="st">'%WESTPAC%'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, seniorsecurity, securityticker, abbrevcompanyname) <span class="sc">|&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-wbc-dplyr" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-wbc-dplyr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: Securities matching <code>WESTPAC</code>: Tidyverse
</figcaption>
<div aria-describedby="tbl-wbc-dplyr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: right;">seniorsecurity</th>
<th style="text-align: left;">securityticker</th>
<th style="text-align: left;">abbrevcompanyname</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">wbc1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">WBC</td>
<td style="text-align: left;">WESTPAC BANKING CORP</td>
</tr>
<tr class="even">
<td style="text-align: left;">wot1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">WOTCA</td>
<td style="text-align: left;">WESTPAC OFFICE TRUST</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wot1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">WOT</td>
<td style="text-align: left;">WESTPAC OFFICE TRUST</td>
</tr>
<tr class="even">
<td style="text-align: left;">wpt1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">WPT</td>
<td style="text-align: left;">WESTPAC PROP. TRUST</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Behind the scenes, the <code>tidyverse</code> package is translating our code into SQL:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>si_au_ref_names <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_like</span>(fullcompanyname, <span class="st">'%WESTPAC%'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, seniorsecurity, securityticker, abbrevcompanyname) <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT gcode, seniorsecurity, securityticker, abbrevcompanyname
FROM si_au_ref_names
WHERE (fullcompanyname LIKE '%WESTPAC%')</code></pre>
</div>
</div>
<p>Alternatively, one can also search by ticker code, as seen in <a href="#tbl-anz-sql" class="quarto-xref">Table&nbsp;6</a> using the <code>securityticker</code> of <code>ANZ</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> gcode, securityticker, abbrevcompanyname</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> si_au_ref_names </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> securityticker <span class="op">=</span> <span class="st">'ANZ'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-anz-sql" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-anz-sql-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6: Securities with ticker <code>ANZ</code>: SQL
</figcaption>
<div aria-describedby="tbl-anz-sql-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: left;">securityticker</th>
<th style="text-align: left;">abbrevcompanyname</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">anz1</td>
<td style="text-align: left;">ANZ</td>
<td style="text-align: left;">AUSTRALIA AND NZ</td>
</tr>
<tr class="even">
<td style="text-align: left;">anz1</td>
<td style="text-align: left;">ANZ</td>
<td style="text-align: left;">ANZ GROUP HOLDINGS</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Again the same query could be run using <code>tidyverse</code> code, with results show in <a href="#tbl-anz-dplyr" class="quarto-xref">Table&nbsp;7</a>. Because it is so straightforward to run SQL queries using R (<code>tidyverse</code>) code, we will just provide R code going forward.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> Note that using R code greatly facilitates bringing the data into R for analysis or (as we will do here) data visualization.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>si_au_ref_names <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(securityticker <span class="sc">==</span> <span class="st">'ANZ'</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, seniorsecurity, securityticker, abbrevcompanyname) <span class="sc">|&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-anz-dplyr" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-anz-dplyr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7: Securities with ticker <code>ANZ</code>: Tidyverse
</figcaption>
<div aria-describedby="tbl-anz-dplyr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: right;">seniorsecurity</th>
<th style="text-align: left;">securityticker</th>
<th style="text-align: left;">abbrevcompanyname</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">anz1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">ANZ</td>
<td style="text-align: left;">AUSTRALIA AND NZ</td>
</tr>
<tr class="even">
<td style="text-align: left;">anz1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">ANZ</td>
<td style="text-align: left;">ANZ GROUP HOLDINGS</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>As another example, suppose one is interested in Arena REIT which has a <code>companyticker</code> of <code>ARF</code>. Searching for this ticker code reveals the <code>gcode</code> of Arena REIT is <code>arf2</code>. This <code>gcode</code> can then be used to search the <code>si_au_prc_daily</code> table for information about the securities of Arena REIT. Results of this search are seen in <a href="#tbl-arf" class="quarto-xref">Table&nbsp;8</a>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>si_au_ref_names <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(companyticker <span class="sc">==</span> <span class="st">'ARF'</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L) <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, securityticker, abbrevcompanyname, </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>         listdate, delistdate) <span class="sc">|&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(listdate) <span class="sc">|&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-arf" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-arf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;8: Securities with ticker <code>ARF</code>
</figcaption>
<div aria-describedby="tbl-arf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: left;">securityticker</th>
<th style="text-align: left;">abbrevcompanyname</th>
<th style="text-align: left;">listdate</th>
<th style="text-align: left;">delistdate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">arf1</td>
<td style="text-align: left;">ARF</td>
<td style="text-align: left;">ARROWFIELD GROUP</td>
<td style="text-align: left;">1987-11-12</td>
<td style="text-align: left;">2000-09-20</td>
</tr>
<tr class="even">
<td style="text-align: left;">arf2</td>
<td style="text-align: left;">ARF</td>
<td style="text-align: left;">ARENA REIT</td>
<td style="text-align: left;">2013-06-13</td>
<td style="text-align: left;">2013-12-10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">arf2</td>
<td style="text-align: left;">ARFDA</td>
<td style="text-align: left;">ARENA REIT</td>
<td style="text-align: left;">2013-12-11</td>
<td style="text-align: left;">2013-12-19</td>
</tr>
<tr class="even">
<td style="text-align: left;">arf2</td>
<td style="text-align: left;">ARF</td>
<td style="text-align: left;">ARENA GROUP</td>
<td style="text-align: left;">2013-12-20</td>
<td style="text-align: left;">2014-01-19</td>
</tr>
<tr class="odd">
<td style="text-align: left;">arf2</td>
<td style="text-align: left;">ARF</td>
<td style="text-align: left;">ARENA REIT</td>
<td style="text-align: left;">2014-01-20</td>
<td style="text-align: left;">2014-12-08</td>
</tr>
<tr class="even">
<td style="text-align: left;">arf2</td>
<td style="text-align: left;">ARFDC</td>
<td style="text-align: left;">ARENA REIT</td>
<td style="text-align: left;">2014-12-09</td>
<td style="text-align: left;">2014-12-15</td>
</tr>
<tr class="odd">
<td style="text-align: left;">arf2</td>
<td style="text-align: left;">ARF</td>
<td style="text-align: left;">ARENA REIT</td>
<td style="text-align: left;">2014-12-16</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The previous search reveals that in 2000, the ticker code ARF was then associated with Arrowfield Group Limited. Arrowfield Group Limited is a different entity to Arena REIT, which was listed in 2013, so the two entities have separate <code>gcode</code>s.</p>
<p>A search for <code>companyticker</code> of <code>ARF</code> also shows that in 2013, the <code>securityticker</code> of Arena REIT briefly changed from <code>ARF</code> to <code>ARFDA</code>, and then back to <code>ARF</code>, due to conversions to and from deferred units. If the holders of units in Arena REIT in 2013 participated in these conversions, then it makes sense to consider them as a single security, which is possible if we accumulate returns using the <code>gcode</code> of <code>arf2</code>, which remains unchanged throughout this period.</p>
</section>
<section id="adjusting-for-the-effects-of-corporate-actions" class="level2">
<h2 class="anchored" data-anchor-id="adjusting-for-the-effects-of-corporate-actions">2. Adjusting for the effects of corporate actions</h2>
<p><a href="#fig-bhp-unadj" class="quarto-xref">Figure&nbsp;1</a> shows a large drop in the closing price of BHP in late June 2001.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">'bhp1'</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">between</span>(date, <span class="st">'2001-01-01'</span>, <span class="st">'2001-12-31'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> close)) <span class="sc">+</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-bhp-unadj" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bhp-unadj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-bhp-unadj-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bhp-unadj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: BHP stock price during 2001
</figcaption>
</figure>
</div>
</div>
</div>
<p>Examining the <code>coraxdescription</code> column, it seems likely that the change is due to a <code>1:0.94</code> bonus issue.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">'bhp1'</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">between</span>(date, <span class="st">'2001-01-01'</span>, <span class="st">'2001-12-31'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(coraxdescription)) <span class="sc">|&gt;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, date, close, coraxdescription) <span class="sc">|&gt;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-bhp-corax" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-bhp-corax-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;9: Corporate action events for BHP in 2001
</figcaption>
<div aria-describedby="tbl-bhp-corax-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: left;">date</th>
<th style="text-align: right;">close</th>
<th style="text-align: left;">coraxdescription</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">bhp1</td>
<td style="text-align: left;">2001-06-29</td>
<td style="text-align: right;">10.39</td>
<td style="text-align: left;">1:0.94 bonus issue</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The <code>coraxdescription</code> column provides details of corporate action (CORAX) events, when available. The <code>numberofdilutionevents</code> field will always show a value greater than 0 when a dilution event (CORAX or dividend) has occurred and <code>numberofcoraxevents &gt; 0</code> indicates CORAX events, even if <code>coraxdescription</code> is not available. Likewise, <code>numberofdividendevents &gt; 0</code> can be used to find all dividend events, even when data are not available in other descriptive fields .</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">'bhp1'</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">between</span>(date, <span class="st">'2001-06-27'</span>, <span class="st">'2001-07-02'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, date, close, factor, numberofcoraxevents) <span class="sc">|&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-bhp-factor" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-bhp-factor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;10: Values of <code>factor</code> for BHP around 27 June 2001
</figcaption>
<div aria-describedby="tbl-bhp-factor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: left;">date</th>
<th style="text-align: right;">close</th>
<th style="text-align: right;">factor</th>
<th style="text-align: right;">numberofcoraxevents</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">bhp1</td>
<td style="text-align: left;">2001-06-27</td>
<td style="text-align: right;">20.946</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">bhp1</td>
<td style="text-align: left;">2001-06-28</td>
<td style="text-align: right;">21.420</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bhp1</td>
<td style="text-align: left;">2001-06-29</td>
<td style="text-align: right;">10.390</td>
<td style="text-align: right;">2.065</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">bhp1</td>
<td style="text-align: left;">2001-07-02</td>
<td style="text-align: right;">10.480</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>How is <code>factor</code> calculated? As seen in <a href="#tbl-bhp-factor" class="quarto-xref">Table&nbsp;10</a>, on most dates <code>factor</code> will be 1, but when a CORAX or dividend event occurs, <code>factor</code> will reflect the factor that allows the previous day’s price to be compared with the current one. With a <code>1:0.94</code> bonus issue, if I have <span class="math inline">\(0.94\)</span> shares one day, I will have <span class="math inline">\(1.94\)</span> shares the next, so <code>factor</code> equals <span class="math inline">\(0.94 / 1.94 = 0.485\)</span>. In other words, the share price of <span class="math inline">\(21.420\)</span> on 28 June 2001 is equivalent to a share price of <span class="math inline">\(21.420 \times 0.485 = 10.379\)</span> on 29 June 2001.</p>
<p>The variable <code>cumulativefactor</code> is calculated from <code>factor</code> to facilitate adjustment of prices along the whole time series. In creating <code>cum_factor_calcs</code>, I replicate the calculation of <code>cumulativefactor</code> from <code>factor</code>. Note that the calculation of <code>cumulativefactor</code> moves from the <em>end</em> of the price series (implied by <code>window_order(desc(date))</code>) for each security (implied by <code>group_by(gcode, seniorsecurity)</code>) and accumulates the absolute value of <code>factor</code> in a multiplicative fashion.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> The calculation uses the <code>lag()</code> function because the first date we want to apply <code>factor</code> for 29 June 2001 to prices is the “next” date (in the reverse-ordered price series) or 28 June 2001.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>cum_factor_calcs <span class="ot">&lt;-</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(gcode, seniorsecurity) <span class="sc">|&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(<span class="fu">desc</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cum_factor_calc =</span> <span class="fu">exp</span>(<span class="fu">cumsum</span>(<span class="fu">log</span>(<span class="fu">abs</span>(factor))))) <span class="sc">|&gt;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cum_factor_calc =</span> <span class="fu">lag</span>(cum_factor_calc) <span class="sc">*</span> <span class="fu">sign</span>(<span class="fu">lag</span>(factor))) <span class="sc">|&gt;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, seniorsecurity, date, close, factor, </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>         cumulativefactor, cum_factor_calc)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="#tbl-bhp-factor-calc" class="quarto-xref">Table&nbsp;11</a> presents <code>cumulativefactor</code>, as calculated by SIRCA, and <code>cum_factor_calc</code>, where I replicate the calculation of <code>cumulativefactor</code> from <code>factor</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>cum_factor_calcs <span class="sc">|&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">'bhp1'</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">between</span>(date, <span class="st">'2001-06-27'</span>, <span class="st">'2001-07-02'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, date, close, factor, cumulativefactor, cum_factor_calc) <span class="sc">|&gt;</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-bhp-factor-calc" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-bhp-factor-calc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;11: Calculated values of <code>factor</code> for BHP around 27 June 2001
</figcaption>
<div aria-describedby="tbl-bhp-factor-calc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: left;">date</th>
<th style="text-align: right;">close</th>
<th style="text-align: right;">factor</th>
<th style="text-align: right;">cumulativefactor</th>
<th style="text-align: right;">cum_factor_calc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">bhp1</td>
<td style="text-align: left;">2001-06-27</td>
<td style="text-align: right;">20.946</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">1.053</td>
<td style="text-align: right;">6.913</td>
</tr>
<tr class="even">
<td style="text-align: left;">bhp1</td>
<td style="text-align: left;">2001-06-28</td>
<td style="text-align: right;">21.420</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">1.053</td>
<td style="text-align: right;">6.913</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bhp1</td>
<td style="text-align: left;">2001-06-29</td>
<td style="text-align: right;">10.390</td>
<td style="text-align: right;">2.065</td>
<td style="text-align: right;">2.175</td>
<td style="text-align: right;">3.348</td>
</tr>
<tr class="even">
<td style="text-align: left;">bhp1</td>
<td style="text-align: left;">2001-07-02</td>
<td style="text-align: right;">10.480</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">2.175</td>
<td style="text-align: right;">3.348</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The <code>cumulativefactor</code> column can be used to adjust the closing price for the effects of corporate actions, such stock splits or entitlement offers, and dividends. Simply multiplying the <code>close</code> column by the <code>cumulativefactor</code> column will produce the adjusted price.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a> si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">'bhp1'</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">between</span>(date, <span class="st">'2001-01-01'</span>, <span class="st">'2001-12-31'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">adjustedprice =</span> close <span class="sc">*</span> cumulativefactor) <span class="sc">|&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(adjustedprice, close), </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"variable"</span>, <span class="at">values_to =</span> <span class="st">"price"</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> price, <span class="at">color =</span> variable)) <span class="sc">+</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-bhp-adj" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bhp-adj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-bhp-adj-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bhp-adj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: BHP adjusted stock price during 2001
</figcaption>
</figure>
</div>
</div>
</div>
<p>In <a href="#fig-bhp-adj" class="quarto-xref">Figure&nbsp;2</a>, <code>adjustedprice</code> series is everywhere lower than <code>close</code> because <code>cumulativefactor</code> adjusts for all subsequent CORAX events and these tend to cause adjusted prices to be lower as one moves back through time (e.g., bonus issues or dividends). The important thing is that the resulting <code>adjustedprice</code> series is consistent over its entire history and can be used to reliably measure returns for <code>bhp1</code> between any two trading dates.</p>
<p>Exactly the same process for <code>cumulativefactor</code> applies for dividends as well as corporate actions. <code>AAA</code> (<code>gcode</code>: <code>aaa2</code>) is an exchange-traded fund that deposits money in accounts with Australian banks and pays regular dividends. The effect of its dividends on its closing price can be observed in <a href="#fig-aaa2" class="quarto-xref">Figure&nbsp;3</a>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">'aaa2'</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">between</span>(date, <span class="st">'2017-01-01'</span>, <span class="st">'2018-12-31'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">adjustedprice =</span> close <span class="sc">*</span> cumulativefactor) <span class="sc">|&gt;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, close, adjustedprice) <span class="sc">|&gt;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>date, <span class="at">names_to =</span> <span class="st">"variable"</span>, <span class="at">values_to =</span> <span class="st">"price"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> price, <span class="at">color =</span> variable)) <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-aaa2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-aaa2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-aaa2-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-aaa2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Adjusted and unadjusted closing prices for <code>AAA</code>
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="plotting-a-distribution-of-price-relatives-for-a-security" class="level2">
<h2 class="anchored" data-anchor-id="plotting-a-distribution-of-price-relatives-for-a-security">3. Plotting a distribution of price relatives for a security</h2>
<p>The following code calculates <code>prel</code>, the price relative or gross shareholder return, for securities on <code>si_au_prc_daily</code>. By using <code>cumulativefactor</code>, it adjusts for corporate actions and dividends.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>prels <span class="ot">&lt;-</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">adjustedprice =</span> close <span class="sc">*</span> cumulativefactor) <span class="sc">|&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(gcode, seniorsecurity) <span class="sc">|&gt;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prel =</span> adjustedprice <span class="sc">/</span> <span class="fu">lag</span>(adjustedprice)) <span class="sc">|&gt;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="#fig-cba1" class="quarto-xref">Figure&nbsp;4</a> shows the distribution of returns from Commonwealth Bank.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>prels <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(prel)) <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">'cba1'</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L) <span class="sc">|&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> prel)) <span class="sc">+</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="fl">0.005</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-cba1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cba1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-cba1-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cba1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Distribution of daily returns for Commonwealth Bank
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="dayssince-column" class="level2">
<h2 class="anchored" data-anchor-id="dayssince-column">4. <code>dayssince</code> column</h2>
<p>It is important to note that price relatives calculated in the previous section may not always relate to consecutive trading days. The following code calculates the number of days between consecutive observations for a given security on <code>si_au_prc_daily</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>elapsed_days <span class="ot">&lt;-</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(gcode, seniorsecurity) <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">days_elapsed =</span> dayssince <span class="sc">-</span> <span class="fu">lag</span>(dayssince)) <span class="sc">|&gt;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="#fig-cba1-days" class="quarto-xref">Figure&nbsp;5</a> shows the distribution of <code>days_elapsed</code>, the number of elapsed days between trading dates calculated using using the <code>datesince</code> column, for Commonwealth Bank. Although CBA is a stock that is consistently traded, a less-liquid security may show large gaps in trading activity, leading to price relatives that span longer time periods.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>elapsed_days <span class="sc">|&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">'cba1'</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L) <span class="sc">|&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(days_elapsed, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(days_elapsed)) <span class="sc">|&gt;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> days_elapsed, <span class="at">y =</span> n)) <span class="sc">+</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-cba1-days" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cba1-days-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-cba1-days-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cba1-days-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Distribution of days between trading dates for Commonwealth Bank
</figcaption>
</figure>
</div>
</div>
</div>
<p>As a measure of the liquidity of a security, <code>days_elapsed</code> is problematic because it does not distinguish between days on which the market is open and those on which it is closed. We can improve on this measure using data from <code>si_au_ref_trddays</code>, a sample of which is shown in <a href="#tbl-trddays" class="quarto-xref">Table&nbsp;12</a>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>si_au_ref_trddays <span class="sc">|&gt;</span> <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-trddays" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-trddays-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12: Sample rows from <code>si_au_ref_trddays</code>
</figcaption>
<div aria-describedby="tbl-trddays-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">date</th>
<th style="text-align: right;">dayssince</th>
<th style="text-align: right;">weekday</th>
<th style="text-align: right;">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2000-01-04</td>
<td style="text-align: right;">36529</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">936</td>
</tr>
<tr class="even">
<td style="text-align: left;">2000-01-05</td>
<td style="text-align: right;">36530</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">958</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2000-01-06</td>
<td style="text-align: right;">36531</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">949</td>
</tr>
<tr class="even">
<td style="text-align: left;">2000-01-07</td>
<td style="text-align: right;">36532</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">927</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2000-01-10</td>
<td style="text-align: right;">36535</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">961</td>
</tr>
<tr class="even">
<td style="text-align: left;">2000-01-11</td>
<td style="text-align: right;">36536</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">984</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2000-01-12</td>
<td style="text-align: right;">36537</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">968</td>
</tr>
<tr class="even">
<td style="text-align: left;">2000-01-13</td>
<td style="text-align: right;">36538</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">971</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2000-01-14</td>
<td style="text-align: right;">36539</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">966</td>
</tr>
<tr class="even">
<td style="text-align: left;">2000-01-17</td>
<td style="text-align: right;">36542</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">976</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Using an approach described in more detail <a href="https://iangow.github.io/far_book/beaver68.html#a-re-evaluation-of-beaver1968vf">here</a>, in place of <code>dayssince</code>, we can create a variable <code>td</code> to represent the “trading date” for each date on <code>si_au_ref_trddays</code> where <code>td</code> equals <code>1</code> on the first trading date, <code>2</code> the second trading date, and so on.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>trading_days <span class="ot">&lt;-</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  si_au_ref_trddays <span class="sc">|&gt;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">td =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(date, td) <span class="sc">|&gt;</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compute</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>With <code>trading_days</code> in hand, we can calculate <code>tdays_elapsed</code> as the number of trading dates between the current date and the previous date on <code>si_au_prc_daily</code> for each security and date.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>tdays_elapsed_df <span class="ot">&lt;-</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(trading_days, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(gcode, seniorsecurity) <span class="sc">|&gt;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tdays_elapsed =</span> td <span class="sc">-</span> <span class="fu">lag</span>(td),</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">lag_date =</span> <span class="fu">lag</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, seniorsecurity, date, lag_date, tdays_elapsed) <span class="sc">|&gt;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="#tbl-tdays" class="quarto-xref">Table&nbsp;13</a> provides data on our improved measure of trading days between trading dates for both Commonwealth Bank (<code>cba1</code>) and a less liquid security (<code>1st1</code>). In <a href="#tbl-tdays" class="quarto-xref">Table&nbsp;13</a>, it can be seen that there are very few cases in which the trading days between dates is more than one for <code>cba1</code>, but quite a few such cases for <code>1st1</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>tdays_elapsed_df <span class="sc">|&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'cba1'</span>, <span class="st">'1st1'</span>), seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(tdays_elapsed)) <span class="sc">|&gt;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(gcode, tdays_elapsed) <span class="sc">|&gt;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"gcode"</span>, <span class="at">values_from =</span> <span class="st">"n"</span>, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(tdays_elapsed) <span class="sc">|&gt;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-tdays" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-tdays-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13: Trading days between trading dates: <code>cba1</code> and <code>1st1</code>
</figcaption>
<div aria-describedby="tbl-tdays-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">tdays_elapsed</th>
<th style="text-align: right;">1st1</th>
<th style="text-align: right;">cba1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1298</td>
<td style="text-align: right;">6314</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">176</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">79</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">134</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p><a href="#tbl-cba1-gaps" class="quarto-xref">Table&nbsp;14</a> provides additional information on the apparent gaps in trading for Commonwealth Bank. We can use these data to investigate the cause of these gaps. Looking at the longest gap, it turns out there was a trading halt placed on <a href="https://announcements.asx.com.au/asxpdf/20150812/pdf/430fwrn8xk90lg.pdf">12 August 2015</a>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>tdays_elapsed_df <span class="sc">|&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">'cba1'</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L, tdays_elapsed <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-cba1-gaps" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-cba1-gaps-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;14: Gaps in trading for Commonwealth Bank
</figcaption>
<div aria-describedby="tbl-cba1-gaps-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: right;">seniorsecurity</th>
<th style="text-align: left;">date</th>
<th style="text-align: left;">lag_date</th>
<th style="text-align: right;">tdays_elapsed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">cba1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">2008-10-09</td>
<td style="text-align: left;">2008-10-07</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">cba1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">2015-08-17</td>
<td style="text-align: left;">2015-08-11</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cba1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">2015-09-14</td>
<td style="text-align: left;">2015-09-10</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">cba1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">2000-03-10</td>
<td style="text-align: left;">2000-03-07</td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>A natural question might be whether there are dates on <code>si_au_prc_daily</code> not found on <code>si_au_ref_trddays</code>. <a href="#tbl-non-trddays" class="quarto-xref">Table&nbsp;15</a> shows that there are, but a small number of securities (in most cases, just one) have data on <code>si_au_prc_daily</code> on those days. I leave it as an exercise for the reader to understand what’s going on in these cases.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(si_au_ref_trddays, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(si_au_prc_daily, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">wday =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-non-trddays" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-non-trddays-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;15: Observations on <code>si_au_prc_daily</code> on non-trading days
</figcaption>
<div aria-describedby="tbl-non-trddays-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">date</th>
<th style="text-align: right;">n</th>
<th style="text-align: left;">wday</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2014-01-01</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">Wed</td>
</tr>
<tr class="even">
<td style="text-align: left;">2000-01-01</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">Sat</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2014-06-01</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">Sun</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-01-01</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">Thu</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2014-11-01</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Sat</td>
</tr>
<tr class="even">
<td style="text-align: left;">2014-03-15</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Sat</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2011-09-10</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Sat</td>
</tr>
<tr class="even">
<td style="text-align: left;">2015-01-01</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Thu</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2009-06-08</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Mon</td>
</tr>
<tr class="even">
<td style="text-align: left;">2011-12-17</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Sat</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="using-the-seniorsecurity-column" class="level2">
<h2 class="anchored" data-anchor-id="using-the-seniorsecurity-column">5. Using the <code>seniorsecurity</code> column</h2>
<p>At times, some <code>gcodes</code> have multiple securities trading simultaneously and SIRCA provides the <code>seniorsecurity</code> field to distinguish different securities for a given firm. In <a href="#tbl-telstra" class="quarto-xref">Table&nbsp;16</a>, two classes of security are shown to be simultaneously trading for Telstra Corporation Ltd, whose <code>gcode</code> is <code>tls1</code>. These are evident from the different <code>securityticker</code> values: <code>TLS</code> and <code>TLSCA</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">'tls1'</span>,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">between</span>(date, <span class="st">"2008-05-01"</span>, <span class="st">"2008-05-07"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, seniorsecurity, date, securityticker) <span class="sc">|&gt;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-telstra" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-telstra-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;16: Sample of <code>securityticker</code> values for Telstra (<code>tls1</code>)
</figcaption>
<div aria-describedby="tbl-telstra-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: right;">seniorsecurity</th>
<th style="text-align: left;">date</th>
<th style="text-align: left;">securityticker</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">tls1</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">2008-05-01</td>
<td style="text-align: left;">TLSCA</td>
</tr>
<tr class="even">
<td style="text-align: left;">tls1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">2008-05-01</td>
<td style="text-align: left;">TLS</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tls1</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">2008-05-02</td>
<td style="text-align: left;">TLSCA</td>
</tr>
<tr class="even">
<td style="text-align: left;">tls1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">2008-05-02</td>
<td style="text-align: left;">TLS</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tls1</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">2008-05-05</td>
<td style="text-align: left;">TLSCA</td>
</tr>
<tr class="even">
<td style="text-align: left;">tls1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">2008-05-05</td>
<td style="text-align: left;">TLS</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tls1</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">2008-05-06</td>
<td style="text-align: left;">TLSCA</td>
</tr>
<tr class="even">
<td style="text-align: left;">tls1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">2008-05-06</td>
<td style="text-align: left;">TLS</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tls1</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">2008-05-07</td>
<td style="text-align: left;">TLSCA</td>
</tr>
<tr class="even">
<td style="text-align: left;">tls1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">2008-05-07</td>
<td style="text-align: left;">TLS</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="sec-neg-fct" class="level2">
<h2 class="anchored" data-anchor-id="sec-neg-fct">6. Negative <code>factor</code> values and zero <code>volumeonmkt</code> values</h2>
<p>When there is either no observed trade price before an event or no price after the event, a <code>factor</code> of <code>-1</code> is assigned to that event. This can occur both in the beginning and the end of the lifetime of the security. <a href="#tbl-num-neg-factors" class="quarto-xref">Table&nbsp;17</a> shows that relatively few observations have negative <code>factor</code> values.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">neg_factor =</span> factor <span class="sc">&lt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(neg_factor)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-num-neg-factors" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-num-neg-factors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;17: Number of observations by negative factors
</figcaption>
<div aria-describedby="tbl-num-neg-factors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">neg_factor</th>
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">9050456</td>
</tr>
<tr class="even">
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">234</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The calculation of <code>cumulativefactor</code> when <code>factor</code> is negative seems to follow the calculation of <code>cum_factor_calc</code> provided above. That is the absolute value is accumulated and multiplied by the sign of the applicable <code>factor</code> value. <a href="#tbl-calc-cumfactor" class="quarto-xref">Table&nbsp;18</a> shows the alignment of <code>cumulativefactor</code> and <code>cum_factor_calc</code> calculated in this way for a stock with a negative value of <code>factor</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>cum_factor_calcs <span class="sc">|&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">"par1"</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">between</span>(date, <span class="st">"2018-12-03"</span>, <span class="st">"2019-02-18"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>seniorsecurity) <span class="sc">|&gt;</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-calc-cumfactor" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-calc-cumfactor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;18: Calculating <code>cumulativefactor</code> with negative <code>factor</code> values
</figcaption>
<div aria-describedby="tbl-calc-cumfactor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: left;">date</th>
<th style="text-align: right;">close</th>
<th style="text-align: right;">factor</th>
<th style="text-align: right;">cumulativefactor</th>
<th style="text-align: right;">cum_factor_calc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">par1</td>
<td style="text-align: left;">2018-12-11</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">1.308</td>
</tr>
<tr class="even">
<td style="text-align: left;">par1</td>
<td style="text-align: left;">2018-12-12</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">1.308</td>
</tr>
<tr class="odd">
<td style="text-align: left;">par1</td>
<td style="text-align: left;">2018-12-14</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">-1.308</td>
</tr>
<tr class="even">
<td style="text-align: left;">par1</td>
<td style="text-align: left;">2019-01-08</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">-1.308</td>
<td style="text-align: right;">-0.005</td>
<td style="text-align: right;">1.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">par1</td>
<td style="text-align: left;">2019-01-24</td>
<td style="text-align: right;">0.005</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">-0.005</td>
<td style="text-align: right;">1.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">par1</td>
<td style="text-align: left;">2019-02-18</td>
<td style="text-align: right;">0.009</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">-0.005</td>
<td style="text-align: right;">1.000</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p><a href="#tbl-strange-factor" class="quarto-xref">Table&nbsp;19</a> shows that the calculation used to produce <code>cum_factor_calc</code> does not always match the valye in <code>cumulativefactor</code>. In this case, it seems that <code>cumulativefactor</code> is mysteriously “reset” to <span class="math inline">\(1\)</span> on 27 September 2018. Further research would be needed to determine</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>cum_factor_calcs <span class="sc">|&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">"gcm2"</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>         factor <span class="sc">!=</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>seniorsecurity) <span class="sc">|&gt;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-strange-factor" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-strange-factor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;19: Case of mysterious <code>factor</code> values
</figcaption>
<div aria-describedby="tbl-strange-factor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: left;">date</th>
<th style="text-align: right;">close</th>
<th style="text-align: right;">factor</th>
<th style="text-align: right;">cumulativefactor</th>
<th style="text-align: right;">cum_factor_calc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2016-09-29</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.010</td>
<td style="text-align: right;">1.010</td>
<td style="text-align: right;">1.155</td>
</tr>
<tr class="even">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2016-12-29</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">1.010</td>
<td style="text-align: right;">1.020</td>
<td style="text-align: right;">1.143</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2017-03-30</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.010</td>
<td style="text-align: right;">1.031</td>
<td style="text-align: right;">1.132</td>
</tr>
<tr class="even">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2017-06-29</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.012</td>
<td style="text-align: right;">1.043</td>
<td style="text-align: right;">1.119</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2017-09-28</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.011</td>
<td style="text-align: right;">1.054</td>
<td style="text-align: right;">1.107</td>
</tr>
<tr class="even">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2017-12-28</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.009</td>
<td style="text-align: right;">1.064</td>
<td style="text-align: right;">1.096</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2018-03-28</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.009</td>
<td style="text-align: right;">1.074</td>
<td style="text-align: right;">1.086</td>
</tr>
<tr class="even">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2018-06-28</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.018</td>
<td style="text-align: right;">1.092</td>
<td style="text-align: right;">1.068</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2018-09-27</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.007</td>
<td style="text-align: right;">1.101</td>
<td style="text-align: right;">1.060</td>
</tr>
<tr class="even">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2018-12-28</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.015</td>
<td style="text-align: right;">1.117</td>
<td style="text-align: right;">1.044</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2019-03-28</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.008</td>
<td style="text-align: right;">1.126</td>
<td style="text-align: right;">1.036</td>
</tr>
<tr class="even">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2019-06-06</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.023</td>
<td style="text-align: right;">1.152</td>
<td style="text-align: right;">1.013</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2019-06-27</td>
<td style="text-align: right;">1.79</td>
<td style="text-align: right;">1.007</td>
<td style="text-align: right;">1.160</td>
<td style="text-align: right;">1.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2019-09-27</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.006</td>
<td style="text-align: right;">1.166</td>
<td style="text-align: right;">1.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gcm2</td>
<td style="text-align: left;">2019-11-20</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">-1.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p><a href="#tbl-strange-factors" class="quarto-xref">Table&nbsp;20</a> flags other difficult-to-explain <code>cumulativefactor</code> values (excluding those where there are sign differences between <code>cum_factor_calc</code> and <code>cumulativefactor</code>). While further research would be needed to understand these, these are fortunately quite rare.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>cum_factor_calcs <span class="sc">|&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">!=</span> <span class="st">"gcm2"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(<span class="fu">abs</span>(cumulativefactor) <span class="sc">-</span> <span class="fu">abs</span>(cum_factor_calc)) <span class="sc">&gt;</span> <span class="fl">0.001</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(gcode, cumulativefactor, cum_factor_calc) <span class="sc">|&gt;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(gcode, cumulativefactor) <span class="sc">|&gt;</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">20</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-strange-factors" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-strange-factors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;20: A sample of other difficult-to-explain <code>factor</code> values
</figcaption>
<div aria-describedby="tbl-strange-factors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: right;">cumulativefactor</th>
<th style="text-align: right;">cum_factor_calc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">14d1</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">1.027</td>
</tr>
<tr class="even">
<td style="text-align: left;">14d1</td>
<td style="text-align: right;">1.021</td>
<td style="text-align: right;">1.006</td>
</tr>
<tr class="odd">
<td style="text-align: left;">14d1</td>
<td style="text-align: right;">1.027</td>
<td style="text-align: right;">1.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">1ad1</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">1.030</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1ad1</td>
<td style="text-align: right;">1.006</td>
<td style="text-align: right;">1.024</td>
</tr>
<tr class="even">
<td style="text-align: left;">1ad1</td>
<td style="text-align: right;">1.024</td>
<td style="text-align: right;">1.006</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1ad1</td>
<td style="text-align: right;">1.030</td>
<td style="text-align: right;">1.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">1al1</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">1.269</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1al1</td>
<td style="text-align: right;">1.040</td>
<td style="text-align: right;">1.221</td>
</tr>
<tr class="even">
<td style="text-align: left;">1al1</td>
<td style="text-align: right;">1.066</td>
<td style="text-align: right;">1.191</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1al1</td>
<td style="text-align: right;">1.104</td>
<td style="text-align: right;">1.150</td>
</tr>
<tr class="even">
<td style="text-align: left;">1al1</td>
<td style="text-align: right;">1.134</td>
<td style="text-align: right;">1.119</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1al1</td>
<td style="text-align: right;">1.175</td>
<td style="text-align: right;">1.081</td>
</tr>
<tr class="even">
<td style="text-align: left;">1al1</td>
<td style="text-align: right;">1.199</td>
<td style="text-align: right;">1.058</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1al1</td>
<td style="text-align: right;">1.246</td>
<td style="text-align: right;">1.019</td>
</tr>
<tr class="even">
<td style="text-align: left;">1al1</td>
<td style="text-align: right;">1.269</td>
<td style="text-align: right;">1.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1gov1</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">1.031</td>
</tr>
<tr class="even">
<td style="text-align: left;">1gov1</td>
<td style="text-align: right;">1.002</td>
<td style="text-align: right;">1.029</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1gov1</td>
<td style="text-align: right;">1.004</td>
<td style="text-align: right;">1.027</td>
</tr>
<tr class="even">
<td style="text-align: left;">1gov1</td>
<td style="text-align: right;">1.006</td>
<td style="text-align: right;">1.025</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The example provided in <a href="#tbl-npx1-factor" class="quarto-xref">Table&nbsp;21</a> shows dividends between <code>2000-03-06</code> and <code>2001-09-28</code> without any trading. As no trading was observed prior to these dividend events, the <code>factor</code> and <code>dividendfactor</code> fields contain a value of <code>-1</code>. This makes sense, as one could not meaningfully push the sequence of stock returns back to dates before <code>2002-03-15</code>, as there are no traded prices. There is a non-negative factor value for <code>2002-03-18</code>, presumably because there are prices reported after <code>2002-03-18</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">'npx1'</span>, date <span class="sc">&lt;=</span> <span class="st">'2002-09-23'</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, date, close, dividend, factor, dividendfactor, volumeonmkt) <span class="sc">|&gt;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-npx1-factor" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-npx1-factor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;21: Negative <code>factor</code> values: <code>npx1</code>
</figcaption>
<div aria-describedby="tbl-npx1-factor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 9%">
<col style="width: 16%">
<col style="width: 9%">
<col style="width: 13%">
<col style="width: 10%">
<col style="width: 22%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: left;">date</th>
<th style="text-align: right;">close</th>
<th style="text-align: right;">dividend</th>
<th style="text-align: right;">factor</th>
<th style="text-align: right;">dividendfactor</th>
<th style="text-align: right;">volumeonmkt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">npx1</td>
<td style="text-align: left;">2000-03-06</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.065</td>
<td style="text-align: right;">-1.000</td>
<td style="text-align: right;">-1.000</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">npx1</td>
<td style="text-align: left;">2000-09-29</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.054</td>
<td style="text-align: right;">-1.000</td>
<td style="text-align: right;">-1.000</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">npx1</td>
<td style="text-align: left;">2001-03-19</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.068</td>
<td style="text-align: right;">-1.000</td>
<td style="text-align: right;">-1.000</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">npx1</td>
<td style="text-align: left;">2001-09-28</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.059</td>
<td style="text-align: right;">-1.000</td>
<td style="text-align: right;">-1.000</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">npx1</td>
<td style="text-align: left;">2002-03-15</td>
<td style="text-align: right;">3.34</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">500</td>
</tr>
<tr class="even">
<td style="text-align: left;">npx1</td>
<td style="text-align: left;">2002-03-18</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.067</td>
<td style="text-align: right;">1.023</td>
<td style="text-align: right;">1.023</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">npx1</td>
<td style="text-align: left;">2002-07-17</td>
<td style="text-align: right;">2.95</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">200</td>
</tr>
<tr class="even">
<td style="text-align: left;">npx1</td>
<td style="text-align: left;">2002-09-23</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.078</td>
<td style="text-align: right;">1.024</td>
<td style="text-align: right;">1.024</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p><a href="#tbl-wsf1-factor" class="quarto-xref">Table&nbsp;22</a> shows another example with a dividend on <code>2004-07-05</code>. However, no price was observed after the event, and hence the <code>factor</code> and <code>dividendfactor</code> fields contain a value of <code>-1</code>. Note that there is a price in the <code>close</code> field on <code>2004-07-05</code> but it was not observed that day, after the dividend event. This is evident from the 0 value for <code>VolumeOnMkt</code>, and confirmed by <code>NA</code> or <code>0</code> values for <code>open</code>, <code>high</code>, <code>low</code>. This price is simply the previous observed trade price carried forward. This makes sense, as one could not meaningfully push the sequence of stock returns forward to dates after <code>2004-07-02</code>, as there are no traded prices.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">'wsf1'</span>, date <span class="sc">&gt;=</span> <span class="st">'2004-07-01'</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, date, close, dividend, factor, dividendfactor, volumeonmkt) <span class="sc">|&gt;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-wsf1-factor" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-wsf1-factor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;22: Dividend example: <code>npx1</code>
</figcaption>
<div aria-describedby="tbl-wsf1-factor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 9%">
<col style="width: 16%">
<col style="width: 9%">
<col style="width: 13%">
<col style="width: 10%">
<col style="width: 22%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: left;">date</th>
<th style="text-align: right;">close</th>
<th style="text-align: right;">dividend</th>
<th style="text-align: right;">factor</th>
<th style="text-align: right;">dividendfactor</th>
<th style="text-align: right;">volumeonmkt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">wsf1</td>
<td style="text-align: left;">2004-07-01</td>
<td style="text-align: right;">15.48</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">8968726</td>
</tr>
<tr class="even">
<td style="text-align: left;">wsf1</td>
<td style="text-align: left;">2004-07-02</td>
<td style="text-align: right;">15.60</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">16453850</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wsf1</td>
<td style="text-align: left;">2004-07-05</td>
<td style="text-align: right;">15.60</td>
<td style="text-align: right;">0.136</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(adjustmentfactor <span class="sc">&lt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(adjustmentfactor)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-neg-adj-fct" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-neg-adj-fct-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;23: Frequency of negative <code>adjustmentfactor</code> values
</figcaption>
<div aria-describedby="tbl-neg-adj-fct-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">adjustmentfactor</th>
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">-1.308</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">-0.025</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-1.000</td>
<td style="text-align: right;">69</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="calculating-a-cumulative-factor-excluding-dividends" class="level2">
<h2 class="anchored" data-anchor-id="calculating-a-cumulative-factor-excluding-dividends">7. Calculating a cumulative factor excluding dividends</h2>
<p>The provided <code>cumulativefactor</code> field of <code>si_au_prc_daily</code> is calculated by cumulating the <code>factor</code> column, whcih adjusts for both corporate actions and dividends. The following example shows how to calculate an adjustment <em>excluding</em> dividends, It uses the <code>adjustmentfactor</code> field, which provides dilution factors for just the CORAX events (when followed at some time by a valid <code>close</code> price).</p>
<p>Use the <code>adjustmentfactor</code> field, which does not account for dividends. Visualise the new adjustment and compare to the adjustment from the example in part 1 Note that the <code>CorpAdjustedPrice</code>, which is calculated without including dividends, looks identical to the <code>close</code> price as no corporate actions have occurred within this time frame.</p>
<p>The following shows the effect that dividends can have on the adjusted price series. The <code>AdjustedPrice</code> series incorporates both CORAX factors and dividend factors, whereas the <code>CorpAdjustedPrice</code> series incorporates only CORAX adjustments and ignores dividends. The CORAX-only price series shows a visible fall at the time when the dividend occurs as the value of the dividend is not accounted for.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>adj_rets <span class="ot">&lt;-</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(gcode, seniorsecurity) <span class="sc">|&gt;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(<span class="fu">desc</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">corporatefactor =</span> <span class="fu">exp</span>(<span class="fu">cumsum</span>(<span class="fu">log</span>(<span class="fu">abs</span>(adjustmentfactor))))) <span class="sc">|&gt;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">corporatefactor =</span> <span class="fu">lag</span>(corporatefactor) <span class="sc">*</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>           <span class="fu">sign</span>(<span class="fu">lag</span>(adjustmentfactor))) <span class="sc">|&gt;</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CorpAdjustedPrice =</span> corporatefactor <span class="sc">*</span> close,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">AdjustedPrice =</span> close <span class="sc">*</span> cumulativefactor) <span class="sc">|&gt;</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>() <span class="sc">|&gt;</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>To plot some date, we first construct <code>anz_cum</code>, which is a version of <code>adj_rets</code> focused on ANZ’s stock price.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>anz_cum <span class="ot">&lt;-</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  adj_rets <span class="sc">|&gt;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">"anz1"</span>, seniorsecurity <span class="sc">==</span> <span class="dv">1</span>L) <span class="sc">|&gt;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, date, CorpAdjustedPrice, AdjustedPrice, close) <span class="sc">|&gt;</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compute</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="#fig-anz-back" class="quarto-xref">Figure&nbsp;6</a> provides a plot of <code>CorpAdjustedPrice</code> (no adjustment for dividends) and <code>AdjustedPrice</code> (adjusted for dividends) for ANZ. One thing that makes this plot difficult to interpret is that the adjustment factors are calculated retrospectively. So <em>going back in time</em> the plots “start” at the same point and “end” at different prices.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>anz_cum <span class="sc">|&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">ends_with</span>(<span class="st">"Price"</span>), </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"series"</span>, <span class="at">values_to =</span> <span class="st">"price"</span>) <span class="sc">|&gt;</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(price)) <span class="sc">|&gt;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> price, <span class="at">color =</span> series)) <span class="sc">+</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-anz-back" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-anz-back-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-anz-back-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-anz-back-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: ANZ: <code>CorpAdjustedPrice</code> and <code>AdjustedPrice</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-anz-fwd" class="quarto-xref">Figure&nbsp;7</a> provides a more intuitive presentation. Rather than calculating returns using the adjusted prices directly, an alternative measure of returns is constructed by calculating a price relative using adjusted prices and then accumulating those returns. As can be seen in <a href="#fig-anz-fwd" class="quarto-xref">Figure&nbsp;7</a>, the two price series start at the same point (no scare quotes because this plot is going forward in time) and end at different points. As would be expected the cumulative returns without dividends are significantly lower by the end of the price series.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>anz_cum <span class="sc">|&gt;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(gcode) <span class="sc">|&gt;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(AdjustedPrice, CorpAdjustedPrice),</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                \(x) <span class="fu">coalesce</span>(x <span class="sc">/</span> <span class="fu">lag</span>(x), <span class="dv">1</span>)),</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>         <span class="fu">across</span>(<span class="fu">c</span>(AdjustedPrice, CorpAdjustedPrice),</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                \(x) <span class="fu">exp</span>(<span class="fu">cumsum</span>(<span class="fu">log</span>(x))))) <span class="sc">|&gt;</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>() <span class="sc">|&gt;</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">ends_with</span>(<span class="st">"Price"</span>), </span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"series"</span>, <span class="at">values_to =</span> <span class="st">"price"</span>) <span class="sc">|&gt;</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(price)) <span class="sc">|&gt;</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> price, <span class="at">color =</span> series)) <span class="sc">+</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-anz-fwd" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-anz-fwd-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-anz-fwd-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-anz-fwd-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: ANZ: Fixed plot of <code>CorpAdjustedPrice</code> and <code>AdjustedPrice</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#tbl-dmg1" class="quarto-xref">Table&nbsp;24</a> presents an example of an even larger difference between the different forms of adjusted price. The dividend of 0.4497 on <code>2012-07-09</code> precedes a fall in <code>close</code> price from 0.575 to 0.019. Adjusting only for CORAX events clearly leads to significantly different measures of share price performance when dividends are also present. If done with case, CORAX adjustments might also be used to standardise earnings information through time.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>adj_rets <span class="sc">|&gt;</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">filter</span>(gcode <span class="sc">==</span> <span class="st">"dmg1"</span>, </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">between</span>(date, <span class="st">"2012-07-01"</span>, <span class="st">"2012-07-13"</span>), </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>        seniorsecurity <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gcode, date, close, dividend, CorpAdjustedPrice, AdjustedPrice) <span class="sc">|&gt;</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-dmg1" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-dmg1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;24: Something about <code>dmg1</code>
</figcaption>
<div aria-describedby="tbl-dmg1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">gcode</th>
<th style="text-align: left;">date</th>
<th style="text-align: right;">close</th>
<th style="text-align: right;">dividend</th>
<th style="text-align: right;">CorpAdjustedPrice</th>
<th style="text-align: right;">AdjustedPrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">dmg1</td>
<td style="text-align: left;">2012-07-02</td>
<td style="text-align: right;">0.570</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">4.577</td>
<td style="text-align: right;">0.570</td>
</tr>
<tr class="even">
<td style="text-align: left;">dmg1</td>
<td style="text-align: left;">2012-07-03</td>
<td style="text-align: right;">0.570</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">4.577</td>
<td style="text-align: right;">0.570</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dmg1</td>
<td style="text-align: left;">2012-07-04</td>
<td style="text-align: right;">0.575</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">4.617</td>
<td style="text-align: right;">0.575</td>
</tr>
<tr class="even">
<td style="text-align: left;">dmg1</td>
<td style="text-align: left;">2012-07-05</td>
<td style="text-align: right;">0.575</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">4.617</td>
<td style="text-align: right;">0.575</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dmg1</td>
<td style="text-align: left;">2012-07-06</td>
<td style="text-align: right;">0.575</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">4.617</td>
<td style="text-align: right;">0.575</td>
</tr>
<tr class="even">
<td style="text-align: left;">dmg1</td>
<td style="text-align: left;">2012-07-09</td>
<td style="text-align: right;">0.019</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">0.019</td>
<td style="text-align: right;">0.602</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dmg1</td>
<td style="text-align: left;">2012-07-10</td>
<td style="text-align: right;">0.020</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.020</td>
<td style="text-align: right;">0.634</td>
</tr>
<tr class="even">
<td style="text-align: left;">dmg1</td>
<td style="text-align: left;">2012-07-11</td>
<td style="text-align: right;">0.019</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.019</td>
<td style="text-align: right;">0.602</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dmg1</td>
<td style="text-align: left;">2012-07-12</td>
<td style="text-align: right;">0.018</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.018</td>
<td style="text-align: right;">0.571</td>
</tr>
<tr class="even">
<td style="text-align: left;">dmg1</td>
<td style="text-align: left;">2012-07-13</td>
<td style="text-align: right;">0.018</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.018</td>
<td style="text-align: right;">0.571</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="segmentation-by-trade-type" class="level2">
<h2 class="anchored" data-anchor-id="segmentation-by-trade-type">8. Segmentation by trade type</h2>
<p>The <code>si_au_prc_daily</code> table also contains information on the count, volume, and value of trades by various categories. This section provides examples of aggregating trading activity by different trade types:</p>
<ol type="1">
<li>Trading activity across the whole market</li>
<li>Segmentation by on- versus off-market trades</li>
<li>Proportion of on-market non-crossing trades that are carried out through ASX Centre Point</li>
<li>Comparison of lit-pool and dark-pool trading</li>
<li>Proportion of dark market trades that are carried out through ASX Centre Point</li>
</ol>
<p><a href="#fig-trd" class="quarto-xref">Figure&nbsp;8</a> shows the value of trading activity across the year plotted against time. Trading activity can vary significantly from month to month.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">floor_date</span>(date, <span class="st">"month"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(month) <span class="sc">|&gt;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">ValueWholeMkt =</span> <span class="fu">sum</span>(valueonmkt <span class="sc">+</span> valueoffmkt, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> month, <span class="at">y =</span> ValueWholeMkt)) <span class="sc">+</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-trd" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-trd-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-trd-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-trd-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Trading activity
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">floor_date</span>(date, <span class="st">"month"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(month) <span class="sc">|&gt;</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">c</span>(valueonmkt, valueoffmkt), \(x) <span class="fu">sum</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))) <span class="sc">|&gt;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>month, <span class="at">names_to =</span> <span class="st">"location"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">|&gt;</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> month, <span class="at">y =</span> value, <span class="at">color =</span> location)) <span class="sc">+</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-trd-on-off" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-trd-on-off-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-trd-on-off-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-trd-on-off-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Trading activity: On- versus off-market
</figcaption>
</figure>
</div>
</div>
</div>
<p>As mentioned above, it is possible to segment the market by the visibility of trades. In the lit market, the order book is public and all orders (bid and offer) are visible to all participants. In contrast, in the dark market, the order book is not visible until trades are executed. The dark pool consists of both on-market and off-market crossing trades, as well as any Centre Point trades. This following section shows the distribution of activity across the lit and dark markets over time. Note: As our Centre Point trade measures include crossing trades, Centre Point crossing trade volumes need to be subtracted to avoid double-counting these trades in the calculation of the dark pool trading.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">floor_date</span>(date, <span class="st">"month"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(volumeonmkt <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(month) <span class="sc">|&gt;</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Dark =</span> <span class="fu">sum</span>(volumeoffmktcross <span class="sc">+</span> volumeonmktcross <span class="sc">+</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>                         volumecentrept <span class="sc">-</span> volumecentreptcross, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">Lit =</span> <span class="fu">sum</span>(volumeonmkt <span class="sc">+</span> volumeoffmkt <span class="sc">-</span> </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>                        (volumeoffmktcross <span class="sc">+</span> volumeonmktcross <span class="sc">+</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>                           volumecentrept <span class="sc">-</span> volumecentreptcross), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>month, <span class="at">names_to =</span> <span class="st">"market"</span>, <span class="at">values_to =</span> <span class="st">"volume"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> month, <span class="at">y =</span> volume, <span class="at">color =</span> market)) <span class="sc">+</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-trd-dark-lit" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-trd-dark-lit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-trd-dark-lit-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-trd-dark-lit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Trading activity: Dark versus lit market
</figcaption>
</figure>
</div>
</div>
</div>
<p>The ASX Centre Point matching system provides a market for dark pool liquidity. As such, Centre Point trades are a subset of on-market trades. More information on ASX Centre Point can be found on the <a href="https://www.asx.com.au/markets/trade-our-cash-market/asx-equities-trading/asx-centre-point.html">ASX website</a>. The composition of each market segment is displayed at the top of the <code>si_au_prc_daily</code> tab in our data dictionary for this service. <a href="#fig-prop-cen-pt" class="quarto-xref">Figure&nbsp;11</a> shows the average proportion of on-market non-crossing trades that are directed through ASX Centre Point over time.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(valueonmkt <span class="sc">&gt;</span> <span class="dv">0</span>, valuecentrept <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">floor_date</span>(date, <span class="st">"month"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(month) <span class="sc">|&gt;</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">AvgPropCentrePtNonCross =</span> </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">sum</span>(valuecentrept <span class="sc">-</span> valuecentreptcross, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">sum</span>(valueonmkt <span class="sc">-</span> valueonmktcross, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> month, <span class="at">y =</span> AvgPropCentrePtNonCross)) <span class="sc">+</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-prop-cen-pt" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-prop-cen-pt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-prop-cen-pt-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prop-cen-pt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Centre Point market share
</figcaption>
</figure>
</div>
</div>
</div>
<p>It is a simple matter to focus on particular market segments. For example, the previous query can be targeted on companies whose market capitalisation is less than $50 million, with results depicted in <a href="#fig-prop-cen-pt-small" class="quarto-xref">Figure&nbsp;12</a>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(close <span class="sc">*</span> shares <span class="sc">&lt;</span> <span class="dv">50000000</span>,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>         valueonmkt <span class="sc">&gt;</span> <span class="dv">0</span>, valuecentrept <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">floor_date</span>(date, <span class="st">"month"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(month) <span class="sc">|&gt;</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">AvgPropCentrePtNonCross =</span> </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">sum</span>(valuecentrept <span class="sc">-</span> valuecentreptcross, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">sum</span>(valueonmkt <span class="sc">-</span> valueonmktcross, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> month, <span class="at">y =</span> AvgPropCentrePtNonCross)) <span class="sc">+</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-prop-cen-pt-small" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-prop-cen-pt-small-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-prop-cen-pt-small-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prop-cen-pt-small-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Centre Point market share: Small caps
</figcaption>
</figure>
</div>
</div>
</div>
<p>Finally, <a href="#fig-prop-cen-dark" class="quarto-xref">Figure&nbsp;13</a> shows the share of the dark market volumes traded on Centre Point.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>si_au_prc_daily <span class="sc">|&gt;</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(valueonmkt <span class="sc">&gt;</span> <span class="dv">0</span>, valuecentrept <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Dark =</span> volumeoffmktcross <span class="sc">+</span> volumeonmktcross <span class="sc">+</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                         volumecentrept <span class="sc">-</span> volumecentreptcross,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">CentrePt =</span> volumecentrept <span class="sc">-</span> volumecentreptcross) <span class="sc">|&gt;</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">floor_date</span>(date, <span class="st">"month"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(month) <span class="sc">|&gt;</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">AvgPropCentrePtDark =</span> <span class="fu">mean</span>(CentrePt <span class="sc">/</span> Dark, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> month, <span class="at">y =</span> AvgPropCentrePtDark)) <span class="sc">+</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-prop-cen-dark" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-prop-cen-dark-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="sirca_eod_files/figure-html/fig-prop-cen-dark-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prop-cen-dark-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Centre Point share of dark market
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(db)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Execute <code>install.packages(c("tidyverse", "DBI", "duckdb", "arrow", "farr", "dbplyr"))</code> within R to install all the packages you need to run the code in this note. While <code>duckdb</code> and <code>arrow</code> are not listed below, they are needed to run the download script and to create the database we will use.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>See <a href="http://www.sirca.org.au/wp-content/uploads/2023/11/How-to-use-the-Data-Library.pdf">SIRCA’s documentation</a> for details on getting the data.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>While we access the data in a database throughout, most of the SQL is generated from <code>tidyverse</code> (R) code rather than being written by us directly.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Users with a background in SQL may find the SQL primer I wrote [here] to be a useful introduction to the <code>dplyr</code> package (this is the component of the <code>tidyverse</code> package that provides the relevant functions).<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>The reason for taking absolute values and accounting for the sign of <code>factor</code> is discussed below in <a href="#sec-neg-fct" class="quarto-xref">Section&nbsp;3.6</a>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Note that the calculation of <code>cum_factor_calc</code> occurs on two separate lines, as DuckDB does not allow nesting of <strong>window functions</strong>, such as <code>cumsum()</code> and <code>lag()</code>. For more on window functions, see <a href="https://iangow.github.io/far_book/fin-state-reprise.html#across-statement-articulation">here</a>.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>