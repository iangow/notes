---
title: "Ben F orgers"
author: Ian D. Gow
date: 2024-04-28
date-format: "D MMMM YYYY"
format:
  html:
    colorlinks: true
  pdf: 
    colorlinks: true
    geometry:
      - left=2.5cm
      - right=2.5cm
    papersize: a4
    mainfont: TeX Gyre Pagella
    mathfont: TeX Gyre Pagella Math
bibliography: papers.bib
---

```{r}
#| message: false
library(tidyverse)
library(DBI)
library(dbplyr)
```

```{r}
db <- dbConnect(duckdb::duckdb())
form_aps <- tbl(db, sql("SELECT * FROM 'data/form_aps.parquet'"))
```

```{r}
form_aps_names <-
  form_aps |> 
  mutate(engagement_partner_name = 
           str_c(engagement_partner_first_name,
                 engagement_partner_middle_name,
                 engagement_partner_last_name, sep = " "))

most_common_name <-
  form_aps_names |>
  count(engagement_partner_id, engagement_partner_name, name = "n_forms") |>
  group_by(engagement_partner_id) |>
  window_order(desc(n_forms)) |>
  filter(row_number() == 1) |>
  select(engagement_partner_id, engagement_partner_name)

names_df <-
  form_aps_names |> 
  group_by(engagement_partner_id) |>
  summarize(n_names = n_distinct(engagement_partner_name)) |>
  inner_join(most_common_name, by = "engagement_partner_id") |>
  relocate(n_names, .after = last_col())
```

```{r}
#| label: tbl-mult-names
#| tbl-cap: Auditors with most reported spellings
#| render: !expr function(x, ...) knitr::knit_print(knitr::kable(x))
names_df |> 
  filter(n_names >= 6) |>
  select(-engagement_partner_id) |>
  arrange(desc(n_names)) 
```

```{r}
#| label: tbl-ben-names
#| tbl-cap: The many names of Ben F orgers
#| render: !expr function(x, ...) knitr::knit_print(knitr::kable(x))
form_aps_names |> 
  filter(engagement_partner_id == "504100001") |> 
  count(engagement_partner_name) |> 
  arrange(desc(n))
```


```{r}
#| label: fig-ft
#| fig-cap: Distribution of auditors by number of reported spellings
names_df |>  
  count(n_names, name = "count") |>
  ggplot(aes(x = n_names, y = count)) +
  geom_col()
```

```{r}
#| label: fig-ft-log1p
#| fig-cap: Distribution of auditors by number of reported spellings ($log(1 + y)$)
names_df |>  
  count(n_names, name = "count") |>
  ggplot(aes(x = n_names, y = count)) +
  geom_col() +
  scale_y_continuous(transform = "log1p")
```

```{r}
dbDisconnect(db)
```
